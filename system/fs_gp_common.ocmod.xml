<?xml version="1.0" encoding="utf-8"?>
<modification>
	<code>fs_gp_common</code>
	<name>Grouped Product - Common</name>
	<version>6.1.0</version>
	<author>Fabio Messina - fabiome77@hotmail.it</author>
	<link>http://www.fabiom7.com</link>
<file path="admin/controller/catalog/product.php">
	<operation info=" get GP Parent ">
		<search><![CDATA[
		$this->load->model('catalog/manufacturer');
		]]></search>
		<add position="after"><![CDATA[
		$data['entry_gp_parent'] = 'Parent Product';
		$data['help_gp_parent'] = 'Prevent to see this product individually in order to go in a Grouped Product.';

		if (isset($this->request->post['gp_parent_id'])) {
			$data['gp_parent_id'] = $this->request->post['gp_parent_id'];
		} elseif (!empty($product_info)) {
			$data['gp_parent_id'] = $product_info['gp_parent_id'];
		} else {
			$data['gp_parent_id'] = 0;
		}

		if (isset($this->request->post['gp_parent'])) {
			$data['gp_parent'] = $this->request->post['gp_parent'];
		} elseif (!empty($product_info['gp_parent_id'])) {
			$gp_parent_info = $this->model_catalog_product->getProduct($product_info['gp_parent_id']);
			$data['gp_parent'] = $gp_parent_info['name'];
		} else {
			$data['gp_parent'] = '';
		}
		]]></add>
	</operation>
	<operation info=" gp filter - getList() ">
		<search><![CDATA[
		protected function getList() {
		]]></search>
		<add position="after"><![CDATA[
		if (isset($this->request->get['filter_gpt'])) {
			$filter_gpt = $data['filter_gpt'] = $this->request->get['filter_gpt'];
		} else {
			$filter_gpt = null;
		}
		]]></add>
	</operation>
	<operation info=" gp filter - autocomplete() ">
		<search><![CDATA[
		public function autocomplete() {
		]]></search>
		<add position="after"><![CDATA[
		if (isset($this->request->get['filter_gpt'])) {
			$filter_gpt = $this->request->get['filter_gpt'];
		} else {
			$filter_gpt = '';
		}
		]]></add>
	</operation>
	<operation info=" gp filter - getList() - autocomplete() ">
		<search><![CDATA[
		$filter_data = array(
		]]></search>
		<add position="after"><![CDATA[
		'filter_gpt' => $filter_gpt,
		]]></add>
	</operation>
	<operation info=" gp filter ">
		<search><![CDATA[
		$url = '';
		]]></search>
		<add position="after"><![CDATA[
		if (isset($this->request->get['filter_gpt'])) {
			$url .= '&filter_gpt=' . urlencode(html_entity_decode($this->request->get['filter_gpt'], ENT_QUOTES, 'UTF-8'));
		}
		]]></add>
	</operation>
</file>
<file path="admin/view/template/catalog/product_list.tpl">
	<operation info=" gp filter - getList() ">
		<search><![CDATA[
		<h3 class="panel-title"><i class="fa fa-list"></i> <?php echo $text_list; ?></h3>
		]]></search>
		<add position="after"><![CDATA[
		<?php if (isset($filter_gpt)) { ?>
		<input type="hidden" name="filter_gpt" value="<?php echo $filter_gpt; ?>" />
		<?php } else { ?>
		<input type="hidden" name="filter_gpt" value="" />
		<?php } ?>
		]]></add>
	</operation>
	<operation info=" gp filter - getList() ">
		<search><![CDATA[
		var filter_name = $('input[name=\'filter_name\']').val();
		]]></search>
		<add position="after"><![CDATA[
		var filter_gpt = $('input[name=\'filter_gpt\']').val();

		if (filter_name) {
			url += '&filter_gpt=' + encodeURIComponent(filter_gpt);
		}
		]]></add>
	</operation>
</file>
<file path="admin/view/template/catalog/product_form.tpl">
	<operation info=" #form-group-gp-parent-id - will be removed if is gp ">
		<search><![CDATA[
		<div class="tab-pane" id="tab-links">
		]]></search>
		<add position="after"><![CDATA[
		<div class="form-group" id="form-group-gp-parent-id">
			<label class="col-sm-2 control-label" for="input-gp-parent"><span data-toggle="tooltip" title="<?php echo $help_gp_parent; ?>"><?php echo $entry_gp_parent; ?></span></label>
			<div class="col-sm-10">
				<input type="text" name="gp_parent" value="<?php echo $gp_parent ?>" placeholder="<?php echo $entry_gp_parent; ?>" id="input-gp-parent" class="form-control" />
				<input type="hidden" name="gp_parent_id" value="<?php echo $gp_parent_id; ?>" />
			</div>
		</div>
<script type="text/javascript"><!--
$('input[name=\'gp_parent\']').autocomplete({
	'source': function(request, response) {
		$.ajax({
			url: 'index.php?route=catalog/product/autocomplete&token=<?php echo $token; ?>&filter_name=' +  encodeURIComponent(request),
			dataType: 'json',
			success: function(json) {
				json.unshift({
					product_id: 0,
					name: '<?php echo $text_none; ?>'
				});
				
				response($.map(json, function(item) {
					return {
						label: item['name'],
						value: item['product_id']
					}
				}));
			}
		});
	},
	'select': function(item) {
		$('input[name=\'gp_parent\']').val(item['label']);
		$('input[name=\'gp_parent_id\']').val(item['value']);
	}	
});
//--></script>
		]]></add>
	</operation>
</file>
<file path="catalog/controller/product/product.php">
	<operation info=" redirect ">
		<search><![CDATA[
		if ($product_info) {
		]]></search>
		<add position="before"><![CDATA[
		if ($product_info && $product_info['gp_parent_id']) {
			$url = '';

			if (isset($this->request->get['path'])) {
				$url .= '&path=' . $this->request->get['path'];
			}

			if (isset($this->request->get['filter'])) {
				$url .= '&filter=' . $this->request->get['filter'];
			}

			if (isset($this->request->get['manufacturer_id'])) {
				$url .= '&manufacturer_id=' . $this->request->get['manufacturer_id'];
			}

			if (isset($this->request->get['search'])) {
				$url .= '&search=' . $this->request->get['search'];
			}

			if (isset($this->request->get['tag'])) {
				$url .= '&tag=' . $this->request->get['tag'];
			}

			if (isset($this->request->get['description'])) {
				$url .= '&description=' . $this->request->get['description'];
			}

			if (isset($this->request->get['category_id'])) {
				$url .= '&category_id=' . $this->request->get['category_id'];
			}

			if (isset($this->request->get['sub_category'])) {
				$url .= '&sub_category=' . $this->request->get['sub_category'];
			}

			if (isset($this->request->get['sort'])) {
				$url .= '&sort=' . $this->request->get['sort'];
			}

			if (isset($this->request->get['order'])) {
				$url .= '&order=' . $this->request->get['order'];
			}

			if (isset($this->request->get['page'])) {
				$url .= '&page=' . $this->request->get['page'];
			}

			if (isset($this->request->get['limit'])) {
				$url .= '&limit=' . $this->request->get['limit'];
			}

			$this->response->redirect($this->url->link('product/product', $url . '&product_id=' . $product_info['gp_parent_id']));
		} else
		]]></add>
	</operation>
</file>
</modification>
