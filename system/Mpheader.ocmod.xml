<?xml version="1.0" encoding="UTF-8"?>
<modification>
        <name>Marketplace for OC v2</name>
        <version>1.0.0</version>
        <code>Webkul Marketplace</code>        
        <author>Webkul</author>
        <link>http://webkul.com</link>

        <file path="admin/controller/common/menu.php">
                <operation>
                        <search><![CDATA[
              return $this->load->view('common/menu.tpl', $data);
                        ]]></search>
                        <add position="before"><![CDATA[
    $data['cp_partnerlist'] = $this->url->link('customerpartner/partner', 'token=' . $this->session->data['token'], 'SSL');
    $data['cp_productlist'] = $this->url->link('customerpartner/product', 'token=' . $this->session->data['token'], 'SSL');
    $data['cp_commission'] = $this->url->link('customerpartner/commission', 'token=' . $this->session->data['token'],'SSL');
    $data['cp_income'] = $this->url->link('customerpartner/income', 'token=' . $this->session->data['token'],'SSL');
    $data['cp_transaction'] = $this->url->link('customerpartner/transaction', 'token=' . $this->session->data['token'],'SSL');
    $data['cp_shipping'] = $this->url->link('customerpartner/shipping', 'token=' . $this->session->data['token'],'SSL');               
    $data['cp_mail'] = $this->url->link('customerpartner/mail', 'token=' . $this->session->data['token'],'SSL');
    $data['wk_customfield'] = $this->url->link('wkcustomfield/wkcustomfield', 'token=' . $this->session->data['token'], 'SSL');
    $data['wk_customer_group'] = $this->url->link('customerpartner/customer_group', 'token=' . $this->session->data['token'],'SSL');
    $data['wkcustomfields'] = false;              
    if($this->config->get('wk_custome_field_wkcustomfields')){
        $data['wkcustomfields'] = true;
    }
                        ]]></add>
                </operation>
        </file>

        <file path="admin/view/template/common/menu.tpl">
                <operation>
                        <search><![CDATA[
    <li id="catalog"><a class="parent"><i class="fa fa-tags fa-fw"></i> <span><?php echo $text_catalog; ?></span></a>                    ]]></search>
                        <add position="before"><![CDATA[                     
    <li id="customerpartner"><a class="parent"><i class="fa fa-users"></i> <span><?php echo "B2B Market Place"; ?></span></a>
      <ul>
        <li><a href="<?php echo $cp_partnerlist; ?>"><?php echo "Partners"; ?></a></li> 
        <li><a href="<?php echo $wk_customer_group; ?>"><?php echo "Customer Group"; ?></a></li>
        <li><a href="<?php echo $cp_commission; ?>"><?php echo "Commission"; ?></a></li>                                      
        <li><a href="<?php echo $cp_productlist ?>"><?php echo "Products"; ?></a></li>
        <li><a href="<?php echo $cp_income ?>"><?php echo "Income"; ?></a></li>
        <li><a href="<?php echo $cp_transaction ?>"><?php echo "Transaction"; ?></a></li>
        <li><a href="<?php echo $cp_shipping ?>"><?php echo "Shipping"; ?></a></li>
        <li><a href="<?php echo $cp_mail ?>"><?php echo "Mail"; ?></a></li>
        <?php if(isset($wkcustomfields) && $wkcustomfields) { ?>
            <li id="wkcustomefield"><a href="<?php echo $wk_customfield; ?>"><?php echo "Custom fields"; ?></a>
        <?php } ?>
      </ul>
    </li>          
                ]]></add>
                </operation>
        </file>

        <file path="admin/view/template/catalog/product_form.tpl">
                <operation>
                        <search><![CDATA[
    <li><a href="#tab-design" data-toggle="tab"><?php echo $tab_design; ?></a></li>
                        ]]></search>
                        <add position="before"><![CDATA[                     
		<li><a href="#tab-vendor" data-toggle="tab">Supplier Links</a></li>         
                ]]></add>
                </operation>
								<operation>
                        <search><![CDATA[<div class="tab-pane" id="tab-design">]]></search>
								<add position="before"><![CDATA[
						<div class="tab-pane" id="tab-vendor">
							<div class="table-responsive">
                <table id="vendor" class="table table-striped table-bordered table-hover">
                  <thead>
										<tr>
											<td class="text-left">Vendor Id</td><td class="text-left">Vendor Name</td><td class="text-left">E-Mail</td><td class="text-left">Price</td><td class="text-left">Quantity</td><td class="text-left">Sort Order</td>
										</tr>
                  </thead>
                  <tbody>
                  <?php if (isset($suppliers)) { ?>
										<?php foreach ($suppliers as $supplier) { ?>
											<tr>
												<td><?php echo $supplier['customer_id']; ?><input type="hidden" value="<?php echo $supplier['customer_id']; ?>" name="vendor[<?php echo $supplier['customer_id']; ?>][id]"></td><td><?php echo $supplier['firstname'].' '.$supplier['lastname']; ?></td><td><?php echo $supplier['email']; ?></td>
												<td><input type="text" name="vendor[<?php echo $supplier['customer_id']; ?>][price]" value="<?php echo $supplier['price']; ?>" class="form-control" size=3></td>
												<td><input type="text" name="vendor[<?php echo $supplier['customer_id']; ?>][quantity]" value="<?php echo $supplier['quantity']; ?>" class="form-control" size=3></td>
												<td><input type="text" name="vendor[<?php echo $supplier['customer_id']; ?>][sort_order]" value="<?php echo $supplier['sort_order']; ?>" class="form-control" size=3></td><td><a onclick="$(this).parent().parent().remove()" data-toggle="tooltip" title="Remove" class="btn btn-danger"><i class="fa fa-minus-circle"></i></a></td>
											</tr>
										<?php } ?>
										<?php } ?>
                  </tbody>
                  <tfoot>
										<tr id="inputcontent">
											<td></td><td><input type="text" name="vendor_name" class="form-control"></td><td></td><td></td><td></td><td></td><td></td>
										</tr>
									</tfoot>
                </table>
              </div>
						</div>
                ]]></add>
                </operation>
								<operation>
                        <search><![CDATA[$('input[name=\'manufacturer\']').autocomplete({]]></search>
								<add position="before"><![CDATA[
		$('input[name=\'vendor_name\']').autocomplete({
			delay: 0,
			source: function(request, response) {
				$.ajax({
					url: 'index.php?route=customerpartner/partner/autocomplete&token=<?php echo $token; ?>&product_id=<?php echo $product_id; ?>&filter_name=' +  encodeURIComponent(request)+'&filter_view=' +  jQuery('#view_all').val(),
					dataType: 'json',
					success: function(json) {   
						response($.map(json, function(item) {
							return {
								label: item.name,
								value: item.id,
								email: item.email
							}
						}));
					}
				});
			}, 
			select: function(item) {
				html = '<tr><td>'+item.value+'<input type="hidden" name="vendor['+item.value+'][id]"  value="'+item.value+'"></td><td>'+item.label+'</td><td>'+item.email+'</td><td><input type="text" name="vendor['+item.value+'][price]" value="" class="form-control"></td><td><input type="text" name="vendor['+item.value+'][quantity]" value="" class="form-control"></td><td><input type="text" name="vendor['+item.value+'][sort_order]" value="" class="form-control"></td><td><a onclick="$(this).parent().parent().remove()" data-toggle="tooltip" title="Remove" class="btn btn-danger"><i class="fa fa-minus-circle"></i></a></td></tr>';
				$('#vendor tbody').append(html);
				return false;
			},
			focus: function(event, ui) {
					return false;
			}
		});
                ]]></add>
                </operation>                
                
                
                
        </file>

        <file path="admin/controller/catalog/product.php">
                <operation>
                        <search><![CDATA[$data['layouts'] = $this->model_design_layout->getLayouts();]]></search>
                        <add position="after"><![CDATA[
			$this->load->model('customerpartner/customerpartner');
			if (isset($this->request->get['product_id'])){
				$data['suppliers'] = $this->model_customerpartner_customerpartner->getSellerByProduct($this->request->get['product_id'],array());
			}
			
                       ]]></add>
                </operation>
        </file>
        <!-- delete product from seller table if admin delete product -->
        <file path="admin/model/catalog/product.php">
                <operation>
                        <search><![CDATA[
    $this->db->query("DELETE FROM " . DB_PREFIX . "review WHERE product_id = '" . (int)$product_id . "'");
                        ]]></search>
                        <add position="after"><![CDATA[
    $this->db->query("DELETE FROM " . DB_PREFIX . "customerpartner_to_product WHERE product_id = '" . (int)$product_id . "'");
    //commented because it's also important for order 
    //$this->db->query("DELETE FROM " . DB_PREFIX . "customerpartner_sold_tracking WHERE product_id = '" . (int)$product_id . "'");
                       ]]></add>
                </operation>
                <operation>
                        <search><![CDATA[
    $this->db->query("DELETE FROM `" . DB_PREFIX . "product_recurring` WHERE product_id = " . (int)$product_id);
                        ]]></search>
                        <add position="after" offset="9"><![CDATA[
		$this->db->query("DELETE FROM `" . DB_PREFIX . "customerpartner_to_product` WHERE product_id = " . (int)$product_id);
		if (isset($data['vendor'])){
			foreach ($data['vendor'] as $customer_id => $vendor){
					$this->db->query("INSERT INTO `" . DB_PREFIX . "customerpartner_to_product` SET `product_id` = " . (int)$product_id.", `customer_id`=".(int)$vendor['id'].", `price`=".(int)$vendor['price'].", `quantity`=".(int)$vendor['quantity'].", `sort_order`=".(int)$vendor['sort_order'].";");
			}
			
		}
                       ]]></add>
                </operation>
                <operation>
                        <search><![CDATA[
    $this->event->trigger('post.admin.product.add', $product_id);
                        ]]></search>
                        <add position="before" offset="3"><![CDATA[
		$this->db->query("DELETE FROM `" . DB_PREFIX . "customerpartner_to_product` WHERE product_id = " . (int)$product_id);
		var_dump($data['vendor']);
		if (isset($data['vendor'])){
			foreach ($data['vendor'] as $customer_id => $vendor){
				$this->db->query("INSERT INTO `" . DB_PREFIX . "customerpartner_to_product` SET `product_id` = " . (int)$product_id.", `customer_id`=".(int)$vendor['id'].", `price`=".(int)$vendor['price'].", `quantity`=".(int)$vendor['quantity'].", `sort_order`=".(int)$vendor['sort_order'].";");
			}
		}
                       ]]></add>
                </operation>
        </file>
				<!--   for delete complete profile after delete seller or customer   -->
        <file path="admin/model/sale/customer.php">
                <operation>
                        <search><![CDATA[
    public function deleteCustomer($customer_id) {
                        ]]></search>
                        <add position="after"><![CDATA[
    //delete customer data from marketplace if exists    
    $this->load->model('customerpartner/partner');                      
    $this->model_customerpartner_partner->deleteCustomer($customer_id);
                         ]]></add>
                </operation>
               
        </file>
				<!--  display seller name with product in order info and after edit   -->    
        <file path="admin/controller/sale/order.php">
            <operation>
                    <search><![CDATA[
                $data['products'][] = array(
                    ]]></search>
                    <add position="before"><![CDATA[                         

    $seller_details = $this->db->query("SELECT c.customer_id,CONCAT(c.firstname,' ',c.lastname) name,c.email FROM ".DB_PREFIX."customerpartner_to_product c2p LEFT JOIN ".DB_PREFIX."customer c ON (c2p.customer_id = c.customer_id) WHERE c2p.product_id = '".(int)$product['product_id']."' AND c2p.quantity > 0  ORDER BY c2p.sort_order ASC")->row;

    if($seller_details AND isset($seller_details['name']) AND $seller_details['name'])
      $product['name'] = $product['name'].'</a> by Seller <a href="'.$this->url->link('customerpartner/partner', 'token=' . $this->session->data['token'] . '&view_all=1&filter_email=' . $seller_details['email'], 'SSL').'"><b>'.$seller_details['name'].'</b></a>';                      

                      ]]></add>
            </operation>

            <operation>
                    <search><![CDATA[
                $data['order_products'][] = array(
                    ]]></search>
                    <add position="before"><![CDATA[                         

    $seller_details = $this->db->query("SELECT c.customer_id,CONCAT(c.firstname,' ',c.lastname) name,c.email FROM ".DB_PREFIX."customerpartner_to_product c2p LEFT JOIN ".DB_PREFIX."customer c ON (c2p.customer_id = c.customer_id) WHERE c2p.product_id = '".(int)$product['product_id']."' AND c2p.quantity > 0 ORDER BY c2p.sort_order ASC")->row;

    if($seller_details AND isset($seller_details['name']) AND $seller_details['name'])
      $product['name'] = $product['name'].' by Seller <b>'.$seller_details['name'].'</b>';                     

                      ]]></add>
            </operation>
               
        </file>
				<!-- Add Customer as Partner -->
        <file path="admin/controller/sale/customer.php">
					<operation>
						 <search><![CDATA[
							 $this->model_sale_customer->addCustomer($this->request->post);
							 ]]></search>
							<add position="replace"><![CDATA[
                $customer_id = $this->model_sale_customer->addCustomer($this->request->post);
						 ]]></add>
					</operation>
					<operation>
						 <search><![CDATA[
							 $this->model_sale_customer->addCustomer($this->request->post);
							 ]]></search>
							<add position="after"><![CDATA[
                if ($this->request->post['tobecomepartner']=='1' && $this->request->post['shoppartner']) {
                    $this->load->model('customerpartner/customerpartner');
										$this->model_customerpartner_customerpartner->becomePartner($customer_id,$this->request->post['shoppartner']);
                }
						 ]]></add>
					</operation>
					<operation>
						 <search><![CDATA[
							 $this->model_sale_customer->editCustomer($this->request->get['customer_id'], $this->request->post);
							 ]]></search>
							<add position="after"><![CDATA[
                if ($this->request->post['tobecomepartner']=='1' && $this->request->post['shoppartner']) {
                    $this->load->model('customerpartner/customerpartner');
										$this->model_customerpartner_customerpartner->becomePartner($this->request->get['customer_id'],$this->request->post['shoppartner']);
                }
						 ]]></add>
					</operation>					
					<operation>
						 <search><![CDATA[
							 protected function getForm() {
							 ]]></search>
							<add position="after"><![CDATA[
            $this->language->load('sale/customerpartner/become_partner');

            $data['text_register_becomePartner'] = $this->language->get('text_register_becomePartner');
            $data['text_register_douwant'] = $this->language->get('text_register_douwant');
            $data['text_shop_name'] = $this->language->get('text_shop_name');
            $data['text_avaiable'] = $this->language->get('text_avaiable');
            $data['text_no_avaiable'] = $this->language->get('text_no_avaiable');

            if (isset($this->request->post['shoppartner'])) {
                $data['shoppartner'] = $this->request->post['shoppartner'];
            } else {
                $data['shoppartner'] = '';
            }

            if (isset($this->request->post['tobecomepartner'])) {
                $data['tobecomepartner'] = $this->request->post['tobecomepartner'];
            } else {
                $data['tobecomepartner'] = '';
            }

            if (isset($this->error['errshoppartner'])) {
                $data['error_shoppartner'] = $this->error['errshoppartner'];
            } else {
                $data['error_shoppartner'] = '';
            }
						$data['marketplace_customerGroup'] = false;
						if($this->config->get('marketplace_customerGroup')){
								$data['marketplace_customerGroup'] = true;
								$this->load->model("customerpartner/customerpartner");
								$filterData = array (
										'start' => 0,
										'limit' => 50,
										'groupIsParent' => 0,
										'groupStatus' => 'enable',
								);
								$data['parentGroups'] = array();
								$parentGroups = $this->model_customerpartner_customerpartner->getCustomerGroupList($filterData);
								if($parentGroups) {
										foreach($parentGroups as $key => $group) {
												$data['parentGroups'][] = array (
														'id' => $group['id'],
														'name' => $group['name'],
														'description' => $group['description'],
												);
										}
								}
						}
						 ]]></add>
					</operation>
        </file>
       <file path="admin/view/template/sale/customer_form.tpl">
                <operation>
                        <search><![CDATA[
                    <select name="safe" id="input-safe" class="form-control">
                        ]]></search>
                        <add position="after" offset="11"><![CDATA[
          <legend><?php echo $text_register_becomePartner; ?></legend>
          <div class="form-group">
            <label class="col-sm-2 control-label"><?php echo $text_register_douwant; ?></label>
            <div class="col-sm-10">
              <?php if ($tobecomepartner) { ?>
              <label class="radio-inline">
                <input type="radio" name="tobecomepartner" value="1" checked="checked" />
                <?php echo $text_yes; ?></label>
              <label class="radio-inline">
                <input type="radio" name="tobecomepartner" value="0" />
                <?php echo $text_no; ?></label>
              <?php } else { ?>
              <label class="radio-inline">
                <input type="radio" name="tobecomepartner" value="1" />
                <?php echo $text_yes; ?></label>
              <label class="radio-inline">
                <input type="radio" name="tobecomepartner" value="0" checked="checked" />
                <?php echo $text_no; ?></label>
              <?php } ?>
            </div>
          </div>

          <div class="form-group required">
            <label class="col-sm-2 control-label" for="input-shop"><?php echo $text_shop_name; ?></label>
            <div class="col-sm-10">
              <div class="input-group"> 
                <span class="input-group-addon"><i class="fa fa-search"></i></span>
                <input type="text" name="shoppartner" value="<?php echo $shoppartner; ?>" placeholder="<?php echo $text_shop_name; ?>" id="input-shop" class="form-control" />                
              </div>
              <?php if ($error_shoppartner) { ?>
              <div class="text-danger"><?php echo $error_shoppartner; ?></div>
              <?php } ?>
            </div>
          </div>
        <script>
            $( "#input-shop" ).change(function() {
              thisshop = this;
              shop = $(thisshop).val();
              
              if(shop){

                jQuery(thisshop).prev().html('<i class="fa fa-spinner fa-spin"></i>');

                $.ajax({
                       type: 'POST',
                       data: ({shop: shop}),
                       dataType: 'json',
                       url: 'index.php?route=customerpartner/sell/wkmpregistation&token=<?php echo $token;?>',
                       success: function(data){     

                          if(data['success']){
                            jQuery(thisshop).prev().html('<span data-toggle="tooltip" class="text-success" title="<?php echo $text_avaiable; ?>"><i class="fa fa-thumbs-o-up"></i></span>');
                          }else if(data['error']){
                            jQuery(thisshop).prev().html('<span data-toggle="tooltip" class="text-danger" title="<?php echo $text_no_avaiable; ?>"><i class="fa fa-thumbs-o-down"></i></span>');
                          }       
                        
                        }
                    });
              }
            });
        </script>
                              ]]></add>
                </operation>
        </file>
				<!-- Sell Link in header -->
				<file path="catalog/controller/common/header.php">
								<operation>
												<search><![CDATA[
						$data['checkout'] = $this->url->link('checkout/checkout', '', 'SSL');
												]]></search>
												<add position="after"><![CDATA[
						$data['menusell'] = $this->url->link('customerpartner/sell', '', 'SSL');
						$data['menu_buy'] = $this->url->link('account/cd', '', 'SSL');
						$this->language->load('module/marketplace');
						$data['text_sell_header'] = $this->language->get('text_sell_header');
						$data['text_my_profile'] = $this->language->get('text_my_profile');
						$data['text_addproduct'] = $this->language->get('text_addproduct');
						$data['text_wkshipping'] = $this->language->get('text_wkshipping');
						$data['text_productlist'] = $this->language->get('text_productlist');
						$data['text_dashboard'] = $this->language->get('text_dashboard');
						$data['text_orderhistory'] = $this->language->get('text_orderhistory');
						$data['text_becomePartner'] = $this->language->get('text_becomePartner');
						$data['text_download'] = $this->language->get('text_download');
						$data['text_transaction'] = $this->language->get('text_transaction'); 
						$data['t_db'] = "Dashboard";
						$data['t_so'] = "Schedule Order";

						$this->load->model('account/customerpartner');
						$data['chkIsPartner'] = $this->model_account_customerpartner->chkIsPartner();
						$data['mp_addproduct'] = $this->url->link('account/customerpartner/addproduct', '', 'SSL');
						$data['mp_productlist'] = $this->url->link('account/customerpartner/productlist', '', 'SSL');
						$data['mp_dashboard'] = $this->url->link('account/customerpartner/dashboard', '', 'SSL');
						$data['mp_add_shipping_mod'] = $this->url->link('account/customerpartner/add_shipping_mod','', 'SSL');
						$data['mp_orderhistory'] = $this->url->link('account/customerpartner/orderlist','', 'SSL');
						$data['mp_download'] = $this->url->link('account/customerpartner/download','', 'SSL');
						$data['mp_profile'] = $this->url->link('account/customerpartner/profile','','SSL');      
						$data['mp_want_partner'] = $this->url->link('account/customerpartner/become_partner','','SSL'); 
						$data['mp_transaction'] = $this->url->link('account/customerpartner/transaction','','SSL'); 
						$data['b_db'] = $this->url->link('account/cd','','SSL');
						$data['b_so'] = $this->url->link('checkout/orderlater','','SSL');

						$rights = $this->model_account_customerpartner->getCustomerGroupRights($this->customer->getGroupId());
						$data['rights'] = $rights['rights'];
						
						]]></add>
								</operation>
				</file>

				<file path="catalog/view/theme/default/template/common/header.tpl">
								<operation>
												<search><![CDATA[
						<li class="dropdown"><a href="<?php echo $account; ?>"
												]]></search>
												<add position="before"><![CDATA[
						<?php if ($logged AND $rights) { ?>
							<li class="dropdown"><a href="<?php echo $menusell; ?>" title="<?php echo $menusell; ?>" class="dropdown-toggle" data-toggle="dropdown"><span class="hidden-lg"><i class="fa fa-users"></i></span>
							<span class="hidden-xs hidden-sm hidden-md"><?php echo $text_sell_header; ?></span> <span class="caret"></span></a>
									<ul class="dropdown-menu dropdown-menu-right">
											<li><a href="<?php echo $mp_profile; ?>"><?php echo $text_my_profile; ?></a></li>
											<li><a href="<?php echo $mp_dashboard; ?>"><?php echo $text_dashboard; ?></a></li>
											<li><a href="<?php echo $mp_orderhistory; ?>"><?php echo $text_orderhistory; ?></a></li>
											<li><a href="<?php echo $mp_transaction; ?>"><?php echo $text_transaction; ?></a></li>
											<li><a href="<?php echo $mp_productlist; ?>"><?php echo $text_productlist; ?></a></li>
											<li><a href="<?php echo $mp_download; ?>"><?php echo $text_download; ?></a></li>
											<li><a href="<?php echo $mp_add_shipping_mod; ?>"><?php echo $text_wkshipping; ?></a></li>
											<li role="presentation" class="divider"></li>
									</ul>
							</li>
						<?php } else { ?>
							<li class="dropdown"><a href="<?php echo $menusell; ?>"><span class="hidden-lg"><i class="fa fa-users"></i></span><span class="hidden-xs hidden-sm hidden-md"><?php echo $text_sell_header; ?></span> </a></li>
						<?php } ?>
						
						<?php if ($logged && $rights) { ?>
						<li class="dropdown"><a href="<?php echo $menu_buy; ?>" title="<?php echo $menu_buy; ?>" class="dropdown-toggle" data-toggle="dropdown"><span class="hidden-lg"><i class="fa fa-tachometer"></i></span></span><span class="hidden-xs hidden-sm hidden-md">Dashboard</span> <span class="caret"></span></a>
								<ul class="dropdown-menu dropdown-menu-right" id="dashboard">
									<?php if (in_array('db',$rights)) {?>
										<li><a href="<?php echo $b_db; ?>"><?php echo $t_db; ?></a></li>
										<li><a href="<?php echo $b_so; ?>"><?php echo $t_so; ?></a></li>
										<?php if (isset($modules['cd'])) {?>
											<li><button id="button-pcd" class="btn">Add Products to DashBoard</button></li>
										<?php } ?>
									<?php } ?>
								</ul>
						</li>
						<?php } ?>
						]]></add>
								</operation>
				</file>

				<file path="catalog/controller/account/register.php">
										<operation>
														<search><![CDATA[
						$data['column_left'] = $this->load->controller('common/column_left');
														]]></search>
														<add position="before"><![CDATA[
						$data['marketplace_becomepartnerregistration'] = $this->config->get('marketplace_becomepartnerregistration');
						if($this->config->get('marketplace_becomepartnerregistration')){

								$this->language->load('account/customerpartner/become_partner');

								$data['text_register_becomePartner'] = $this->language->get('text_register_becomePartner');
								$data['text_register_douwant'] = $this->language->get('text_register_douwant');
								$data['text_shop_name'] = $this->language->get('text_shop_name');
								$data['text_avaiable'] = $this->language->get('text_avaiable');
								$data['text_no_avaiable'] = $this->language->get('text_no_avaiable');

								if (isset($this->request->post['shoppartner'])) {
										$data['shoppartner'] = $this->request->post['shoppartner'];
								} else {
										$data['shoppartner'] = '';
								}

								if (isset($this->request->post['tobecomepartner'])) {
										$data['tobecomepartner'] = $this->request->post['tobecomepartner'];
								} else {
										$data['tobecomepartner'] = '';
								}

								if (isset($this->error['errshoppartner'])) {
										$data['error_shoppartner'] = $this->error['errshoppartner'];
								} else {
										$data['error_shoppartner'] = '';
								}

						}
						$data['marketplace_customerGroup'] = false;
						if($this->config->get('marketplace_customerGroup')){
								$data['marketplace_customerGroup'] = true;
								$this->load->model("account/customerpartner");
								$filterData = array (
										'start' => 0,
										'limit' => 50,
										'groupIsParent' => 0,
										'groupStatus' => 'enable',
								);
								$data['parentGroups'] = array();
								$parentGroups = $this->model_account_customerpartner->getCustomerGroupList($filterData);
								if($parentGroups) {
										foreach($parentGroups as $key => $group) {
												$data['parentGroups'][] = array (
														'id' => $group['id'],
														'name' => $group['name'],
														'description' => $group['description'],
												);
										}
								}
						}

														]]></add>
										</operation>

										<operation>
														<search><![CDATA[
						public function validate() {
														]]></search>
														<add position="after"><![CDATA[

						if($this->config->get('marketplace_becomepartnerregistration') AND isset($this->request->post['tobecomepartner'])){        

								$this->language->load('account/customerpartner/become_partner');

								if(utf8_strlen($this->request->post['shoppartner'])<=3 && $this->request->post['tobecomepartner']==1){
										$this->error['errshoppartner'] = $this->language->get('error_validshop');
								}else if(utf8_strlen($this->request->post['shoppartner']) >1 && $this->request->post['tobecomepartner']==1){
										$this->load->model('customerpartner/master');                           
										if(!$this->model_customerpartner_master->getShopData($this->request->post['shoppartner'])){
											$this->error['errshoppartner'] = $this->language->get('error_noshop');
										}
								}

								$this->language->load('account/register');
						}
														]]></add>
										</operation>

										<operation>
														<search><![CDATA[
						unset($this->session->data['guest']);
														]]></search>
														<add position="before"><![CDATA[
								if($this->config->get('marketplace_becomepartnerregistration')){
										if ($this->request->post['tobecomepartner']=='1' && $this->request->post['shoppartner']) {
												$this->load->model('account/customerpartner');
												$this->model_account_customerpartner->becomePartner($this->request->post['shoppartner']);
										} 
								}                

													 ]]></add>
										</operation>

						</file>

    <!--   for delete complete profile after delete seller or customer   -->

        <file path="catalog/view/theme/*/template/account/register.tpl">
                <operation>
                        <search><![CDATA[
                    <?php if ($text_agree) { ?>
                        ]]>
                        </search>
                        <add position="before"><![CDATA[
					<?php if($marketplace_becomepartnerregistration){ ?>

        <fieldset>
          <legend><?php echo $text_register_becomePartner; ?></legend>
          <div class="form-group">
            <label class="col-sm-2 control-label"><?php echo $text_register_douwant; ?></label>
            <div class="col-sm-10">
              <?php if ($tobecomepartner) { ?>
              <label class="radio-inline">
                <input type="radio" name="tobecomepartner" value="1" checked="checked" />
                <?php echo $text_yes; ?></label>
              <label class="radio-inline">
                <input type="radio" name="tobecomepartner" value="0" />
                <?php echo $text_no; ?></label>
              <?php } else { ?>
              <label class="radio-inline">
                <input type="radio" name="tobecomepartner" value="1" />
                <?php echo $text_yes; ?></label>
              <label class="radio-inline">
                <input type="radio" name="tobecomepartner" value="0" checked="checked" />
                <?php echo $text_no; ?></label>
              <?php } ?>
            </div>
          </div>

          <div class="form-group required">
            <label class="col-sm-2 control-label" for="input-shop"><?php echo $text_shop_name; ?></label>
            <div class="col-sm-10">
              <div class="input-group"> 
                <span class="input-group-addon"><i class="fa fa-search"></i></span>
                <input type="text" name="shoppartner" value="<?php echo $shoppartner; ?>" placeholder="<?php echo $text_shop_name; ?>" id="input-shop" class="form-control" />                
              </div>
              <?php if ($error_shoppartner) { ?>
              <div class="text-danger"><?php echo $error_shoppartner; ?></div>
              <?php } ?>
            </div>
          </div>

        </fieldset>

        <script>
            $( "#input-shop" ).change(function() {
              thisshop = this;
              shop = $(thisshop).val();
              
              if(shop){

                jQuery(thisshop).prev().html('<i class="fa fa-spinner fa-spin"></i>');

                $.ajax({
                       type: 'POST',
                       data: ({shop: shop}),
                       dataType: 'json',
                       url: 'index.php?route=customerpartner/sell/wkmpregistation',
                       success: function(data){     

                          if(data['success']){
                            jQuery(thisshop).prev().html('<span data-toggle="tooltip" class="text-success" title="<?php echo $text_avaiable; ?>"><i class="fa fa-thumbs-o-up"></i></span>');
                          }else if(data['error']){
                            jQuery(thisshop).prev().html('<span data-toggle="tooltip" class="text-danger" title="<?php echo $text_no_avaiable; ?>"><i class="fa fa-thumbs-o-down"></i></span>');
                          }       
                        
                        }
                    });
              }
            });
        </script>
    <?php } ?>

    <?php if($marketplace_customerGroup) { ?>
        <fieldset>
            <legend>Become Multi user customer</legend>
            <div class="form-group">
                <label class="col-sm-2 control-label">Customer Group</label>
                <div class="col-sm-10" >
                    <select class="form-control" name="mpCustomerGroup">
                        <option value=""></option>
                        <?php if($parentGroups) { ?>
                            <?php foreach($parentGroups as $key => $group) { ?>
                                <option value="<?php echo $group['id'] ?>" title="<?php echo $group['description'] ?>"><?php echo $group['name'] ?></option>
                            <?php } ?>    
                        <?php } ?>
                    </select>
                </div>
            </div>
        </fieldset>
        <script type="text/javascript">
            $('#account div.form-group:nth-child(2)').css('display','none');
            $('select[name="mpCustomerGroup"]').on('change',function(){
                val = $(this).val();
                $.each($('input[name="customer_group_id"]'),function(){
                    if($(this).val() == val) {
                        $(this).prop("checked","checked");
                    }
                });
            });
        </script>
    <?php } ?>
                              ]]></add>
                </operation>
        </file>


        <!-- send mail to seller after product sold -->


    <file path="catalog/controller/checkout/checkout.php">
    <operation>
    <search><![CDATA[
    $products = $this->cart->getProducts();
    ]]></search>
    <add position="before" offset="1" ><![CDATA[
    /*
    To check customer has access to order or not
    */
    if($this->config->get('marketplace_status')) {
        $this->load->model('account/customerpartner');
        $this->load->language('customerpartner/orderReview');
				
        $customerRights = $this->model_account_customerpartner->getCustomerGroupRights($this->customer->getGroupId());

        $approvedDetails = $this->model_account_customerpartner->getApprovedProducts($this->customer->getId());
        $approveProducts = unserialize($approvedDetails['approve_cart']);

        if($customerRights && !array_key_exists('make-order', $customerRights['rights'])) {
            $this->session->data['forReview'] = true;
            $currentCart = $this->session->data['cart'];
            if($approveProducts) {
                foreach ($currentCart as $key => $value) {
                    if(!array_key_exists($key, $approveProducts)) {
                        $this->session->data['warning'] = $this->language->get('warning_reviewtoadmin');
                        $this->response->redirect($this->url->link('account/customerpartner/orderReview','', 'SSL'));
                    }
                }
            } else if(!$approveProducts) {
                $this->session->data['warning'] = " Warning: You are not allowed to place order without permission, please send your order for review to your administrator!";
                $this->response->redirect($this->url->link('account/customerpartner/orderReview','', 'SSL'));
            }
        }
    }
    /*
    end here
    */
    ]]></add>
    </operation>
    </file>

    <file path="catalog/controller/checkout/checkout_onepage.php">
    <operation>
    <search><![CDATA[
    $this->load->model('checkout/checkout_onepage');
    ]]></search>
    <add position="after"><![CDATA[
    /*
    To check customer has access to order or not
    */
    if($this->config->get('marketplace_status')) {
        $this->load->model('account/customerpartner');
        $this->load->language('customerpartner/orderReview');
				
        $customerRights = $this->model_account_customerpartner->getCustomerGroupRights($this->customer->getGroupId());

        $approvedDetails = $this->model_account_customerpartner->getApprovedProducts($this->customer->getId());
        $approveProducts = unserialize($approvedDetails['approve_cart']);

				$total = $this->cart->getTotal();
				
				$limit =  $this->model_account_customerpartner->getUser();
				
			 if($customerRights && !array_key_exists('make-order', $customerRights['rights'])) {
            $this->session->data['forReview'] = true;
            $currentCart = $this->session->data['cart'];
            if($approveProducts) {
                foreach ($currentCart as $key => $value) {
                    if(!array_key_exists($key, $approveProducts)) {
                        $this->session->data['warning'] = $this->language->get('warning_reviewtoadmin');
                        $this->response->redirect($this->url->link('account/customerpartner/orderReview','', 'SSL'));
                    }
                }
            } else if(!$approveProducts) {
                $this->session->data['warning'] = " Warning: You are not allowed to place order without permission, please send your order for review to your administrator!";
                $this->response->redirect($this->url->link('account/customerpartner/orderReview','', 'SSL'));
            }
        }
				if($limit && ($limit['p_limit'] < $total)) {
				
						$this->session->data['forReview'] = true;
            $currentCart = $this->session->data['cart'];
            if($approveProducts) {
                foreach ($currentCart as $key => $value) {
                    if(!array_key_exists($key, $approveProducts)) {
                        $this->session->data['warning'] = $this->language->get('warning_reviewtoadmin');
                        $this->response->redirect($this->url->link('account/customerpartner/orderReview','', 'SSL'));
                    }
                }
            } else if(!$approveProducts) {
                $this->session->data['warning'] = " Warning: You have crossed the purchase limit, please send your order for review to your administrator!";
                $this->response->redirect($this->url->link('account/customerpartner/orderReview','', 'SSL'));
            }
				}
        
    }
    /*
    end here
    */
    ]]></add>
    </operation>
    </file>

    <file path="catalog/controller/checkout/confirm.php,catalog/controller/checkout/confirm_onepage.php">
    <operation>
    <search><![CDATA[
    $customer_info = $this->model_account_customer->getCustomer($this->customer->getId());
    ]]></search>
    <add position="replace" offset="2" ><![CDATA[
    /*
    To order by company name not by sub user
    */
    if($this->config->get('marketplace_status')) {
       $this->load->model('account/customerpartner');
       $sellerId = $this->model_account_customerpartner->isSubUser($this->customer->getId());
       if($sellerId) {
            $sellerId = $sellerId;
       } else {
            $sellerId = $this->customer->getId();
       }
       $customer_info = $this->model_account_customer->getCustomer($sellerId);
       $order_data['customer_id'] = $sellerId;
    } else {
        $customer_info = $this->model_account_customer->getCustomer($this->customer->getId());
        $order_data['customer_id'] = $this->customer->getId();
    }
    /*
    end here
    */
    ]]></add>
    </operation>
    </file>

    <file path="catalog/controller/checkout/success.php">
    <operation>
    <search><![CDATA[
    $this->cart->clear();
    ]]></search>
    <add position="after" ><![CDATA[
            /*
            To close previous review
            */
            if($this->config->get('marketplace_status')) {
               $this->load->model('account/customerpartner');
               $this->model_account_customerpartner->closePreviousReview($this->customer->getId(),$this->session->data['order_id']);
            }
            /*
            end here
            */
    ]]></add>
    </operation>
    </file>

    <file path="catalog/model/account/order.php">
    <operation>
    <search><![CDATA[
    $order_query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "order` WHERE order_id = '" . (int)$order_id . "' AND customer_id = '" . (int)$this->customer->getId() . "' AND order_status_id > '0'");
    ]]></search>
    <add position="replace" ><![CDATA[
        /*
        To get company orders not individuals for sub users
        */
        if($this->config->get('marketplace_status')) {
           $this->load->model('account/customerpartner');
           $sellerId = $this->model_account_customerpartner->isSubUser($this->customer->getId());
           if($sellerId) {
                $sellerId = $sellerId;
           } else {
                $sellerId = $this->customer->getId();
           }
           $order_query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "order` WHERE order_id = '" . (int)$order_id . "' AND customer_id = '" . (int)$sellerId . "' AND order_status_id > '0'");
        } else {
            $order_query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "order` WHERE order_id = '" . (int)$order_id . "' AND customer_id = '" . (int)$this->customer->getId() . "' AND order_status_id > '0'");
        }
        /*
        end here
        */
    ]]></add>
    </operation>
    <operation>
    <search><![CDATA[
    $query = $this->db->query("SELECT o.order_id, o.firstname, o.lastname, os.name as status, o.date_added, o.total, o.currency_code, o.currency_value FROM `" . DB_PREFIX . "order` o LEFT JOIN " . DB_PREFIX . "order_status os ON (o.order_status_id = os.order_status_id) WHERE o.customer_id = '" . (int)$this->customer->getId() . "' AND o.order_status_id > '0' AND o.store_id = '" . (int)$this->config->get('config_store_id') . "' AND os.language_id = '" . (int)$this->config->get('config_language_id') . "' ORDER BY o.order_id DESC LIMIT " . (int)$start . "," . (int)$limit);
    ]]></search>
    <add position="replace" ><![CDATA[
        /*
        To get company orders not individuals for sub users
        */
        if($this->config->get('marketplace_status')) {
           $this->load->model('account/customerpartner');
           $sellerId = $this->model_account_customerpartner->isSubUser($this->customer->getId());
           if($sellerId) {
                $sellerId = $sellerId;
           } else {
                $sellerId = $this->customer->getId();
           }
           $query = $this->db->query("SELECT o.order_id, o.firstname, o.lastname, os.name as status, o.date_added, o.total, o.currency_code, o.currency_value FROM `" . DB_PREFIX . "order` o LEFT JOIN " . DB_PREFIX . "order_status os ON (o.order_status_id = os.order_status_id) WHERE o.customer_id = '" . (int)$sellerId . "' AND o.order_status_id > '0' AND o.store_id = '" . (int)$this->config->get('config_store_id') . "' AND os.language_id = '" . (int)$this->config->get('config_language_id') . "' ORDER BY o.order_id DESC LIMIT " . (int)$start . "," . (int)$limit);
        } else {
            $query = $this->db->query("SELECT o.order_id, o.firstname, o.lastname, os.name as status, o.date_added, o.total, o.currency_code, o.currency_value FROM `" . DB_PREFIX . "order` o LEFT JOIN " . DB_PREFIX . "order_status os ON (o.order_status_id = os.order_status_id) WHERE o.customer_id = '" . (int)$this->customer->getId() . "' AND o.order_status_id > '0' AND o.store_id = '" . (int)$this->config->get('config_store_id') . "' AND os.language_id = '" . (int)$this->config->get('config_language_id') . "' ORDER BY o.order_id DESC LIMIT " . (int)$start . "," . (int)$limit);
        }
        /*
        end here
        */
    ]]></add>
    </operation>
    <operation>
    <search><![CDATA[
    $query = $this->db->query("SELECT COUNT(*) AS total FROM `" . DB_PREFIX . "order` o WHERE customer_id = '" . (int)$this->customer->getId() . "' AND o.order_status_id > '0' AND o.store_id = '" . (int)$this->config->get('config_store_id') . "'");
    ]]></search>
    <add position="replace" ><![CDATA[
        /*
        To get company orders not individuals for sub users
        */
        if($this->config->get('marketplace_status')) {
           $this->load->model('account/customerpartner');
           $sellerId = $this->model_account_customerpartner->isSubUser($this->customer->getId());
           if($sellerId) {
                $sellerId = $sellerId;
           } else {
                $sellerId = $this->customer->getId();
           }
           $query = $this->db->query("SELECT COUNT(*) AS total FROM `" . DB_PREFIX . "order` o WHERE customer_id = '" . (int)$sellerId . "' AND o.order_status_id > '0' AND o.store_id = '" . (int)$this->config->get('config_store_id') . "'");
        } else {
            $query = $this->db->query("SELECT COUNT(*) AS total FROM `" . DB_PREFIX . "order` o WHERE customer_id = '" . (int)$this->customer->getId() . "' AND o.order_status_id > '0' AND o.store_id = '" . (int)$this->config->get('config_store_id') . "'");
        }
        /*
        end here
        */
    ]]></add>
    </operation>
    </file>
    
 		<file path="catalog/controller/product/category.php,catalog/controller/product/manufacturer.php,catalog/controller/product/search.php">
			<operation>
				<search><![CDATA[
					$price = $this->currency->format($this->tax->calculate($result['price'], $result['tax_class_id'], $this->config->get('config_tax')));
				]]></search>
				<add position="after"><![CDATA[
					$original_price  = 0;
					$discount = 0;				
					if ($result['price'] < $result['original_price']) {
						$original_price = $this->currency->format($this->tax->calculate($result['original_price'], $result['tax_class_id'], $this->config->get('config_tax')));
						$discount = (int)(($result['original_price'] - $result['price'])*100/$result['original_price']);
					}
				]]></add>
			</operation>
			<operation>
				<search><![CDATA[
					'price'       => $price,
				]]></search>
				<add position="after"><![CDATA[
					'original_price' => $original_price,
					'discount' => $discount,				
				]]></add>
			</operation>
    </file>
    
       
		<file path="catalog/controller/product/product.php">
			<operation>
			<search><![CDATA[
				if (isset($this->request->get['product_id']))
			]]></search>
			<add position="before"><![CDATA[
				if (isset($this->request->get['vendor_id'])) {
					$vendor_id = $this->request->get['vendor_id'];
				} else {
					$vendor_id = 0;
				}
			]]></add>
    </operation>
    <operation>
			<search><![CDATA[
				$data['column_left'] = $this->load->controller('common/column_left');
			]]></search>
			<add position="after"><![CDATA[
				$data['curr_vendor'] = $product_info['curr_vendor'];
				$data['vendors'] = $product_info['vendors'];
				foreach ($product_info['vendors'] as $key => $vendor) {
					$data['vendors'][$key]['link'] = $this->url->link('product/product', '&vendor_id='.$vendor['vendor_id'].'&product_id=' . $product_id ,'SSL');
					$data['vendors'][$key]['price'] = $this->currency->format($this->tax->calculate($vendor['price'], $product_info['tax_class_id'], $this->config->get('config_tax')));
				}
				$data['vlink'] = $this->url->link('customerpartner/profile','id='.$product_info['curr_vendor']['vendor_id'],'SSL');
			]]></add>
    </operation>
      <operation>
				<search><![CDATA[
					$data['price'] = $this->currency->format($this->tax->calculate($product_info['price'], $product_info['tax_class_id'], $this->config->get('config_tax')));
				]]></search>
				<add position="after"><![CDATA[
					$data['original_price']  = 0;
					$data['discount'] = 0;
					if ($product_info['price'] < $product_info['original_price']) {
						$data['original_price'] = $this->currency->format($this->tax->calculate($product_info['original_price'], $product_info['tax_class_id'], $this->config->get('config_tax')));
						
						$data['discount'] = (int)(($product_info['original_price'] - $product_info['price'])*100/$product_info['original_price']);
					}
				]]></add>
			</operation>
			<operation>
				<search><![CDATA[
					$discounts = $this->model_catalog_product->getProductDiscounts($this->request->get['product_id']);
				]]></search>
				<add position="after"><![CDATA[
					if (!empty($product_info['curr_vendor']['id'])) {
						$discounts = $this->model_catalog_product->getSupplierProductDiscounts($product_info['curr_vendor']['id']);
					}
				]]></add>
			</operation>
			
			
    </file>
			
    <file path="catalog/model/catalog/product.php">
    <operation>
    <search><![CDATA[
    $query = $this->db->query("SELECT DISTINCT *, pd.name AS name, p.image, m.name AS manufacturer, (SELECT price FROM " . DB_PREFIX . "product_discount pd2 WHERE pd2.product_id = p.product_id AND pd2.customer_group_id = '" . (int)$this->config->get('config_customer_group_id') . "' AND pd2.quantity = '1' AND ((pd2.date_start = '0000-00-00' OR pd2.date_start < NOW()) AND (pd2.date_end = '0000-00-00' OR pd2.date_end > NOW())) ORDER BY pd2.priority ASC, pd2.price ASC LIMIT 1) AS discount, (SELECT price FROM " . DB_PREFIX . "product_special ps WHERE ps.product_id = p.product_id AND ps.customer_group_id = '" . (int)$this->config->get('config_customer_group_id') . "' AND ((ps.date_start = '0000-00-00' OR ps.date_start < NOW()) AND (ps.date_end = '0000-00-00' OR ps.date_end > NOW())) ORDER BY ps.priority ASC, ps.price ASC LIMIT 1) AS special, (SELECT points FROM " . DB_PREFIX . "product_reward pr WHERE pr.product_id = p.product_id AND customer_group_id = '" . (int)$this->config->get('config_customer_group_id') . "') AS reward, (SELECT ss.name FROM " . DB_PREFIX . "stock_status ss WHERE ss.stock_status_id = p.stock_status_id AND ss.language_id = '" . (int)$this->config->get('config_language_id') . "') AS stock_status, (SELECT wcd.unit FROM " . DB_PREFIX . "weight_class_description wcd WHERE p.weight_class_id = wcd.weight_class_id AND wcd.language_id = '" . (int)$this->config->get('config_language_id') . "') AS weight_class, (SELECT lcd.unit FROM " . DB_PREFIX . "length_class_description lcd WHERE p.length_class_id = lcd.length_class_id AND lcd.language_id = '" . (int)$this->config->get('config_language_id') . "') AS length_class, (SELECT AVG(rating) AS total FROM " . DB_PREFIX . "review r1 WHERE r1.product_id = p.product_id AND r1.status = '1' GROUP BY r1.product_id) AS rating, (SELECT COUNT(*) AS total FROM " . DB_PREFIX . "review r2 WHERE r2.product_id = p.product_id AND r2.status = '1' GROUP BY r2.product_id) AS reviews, p.sort_order FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) LEFT JOIN " . DB_PREFIX . "manufacturer m ON (p.manufacturer_id = m.manufacturer_id) WHERE p.product_id = '" . (int)$product_id . "' AND pd.language_id = '" . (int)$this->config->get('config_language_id') . "' AND p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "'");
    ]]></search>
    <add position="replace" ><![CDATA[
			$query = $this->db->query("SELECT DISTINCT *, pd.name AS name, p.image, m.name AS manufacturer, (SELECT price FROM " . DB_PREFIX . "product_discount pd2 WHERE pd2.product_id = p.product_id AND pd2.customer_group_id = '" . (int)$this->config->get('config_customer_group_id') . "' AND pd2.quantity = '1' AND ((pd2.date_start = '0000-00-00' OR pd2.date_start < NOW()) AND (pd2.date_end = '0000-00-00' OR pd2.date_end > NOW())) ORDER BY pd2.priority ASC, pd2.price ASC LIMIT 1) AS discount, (SELECT price FROM " . DB_PREFIX . "product_special ps WHERE ps.product_id = p.product_id AND ps.customer_group_id = '" . (int)$this->config->get('config_customer_group_id') . "' AND ((ps.date_start = '0000-00-00' OR ps.date_start < NOW()) AND (ps.date_end = '0000-00-00' OR ps.date_end > NOW())) ORDER BY ps.priority ASC, ps.price ASC LIMIT 1) AS special, (SELECT points FROM " . DB_PREFIX . "product_reward pr WHERE pr.product_id = p.product_id AND customer_group_id = '" . (int)$this->config->get('config_customer_group_id') . "') AS reward, (SELECT ss.name FROM " . DB_PREFIX . "stock_status ss WHERE ss.stock_status_id = p.stock_status_id AND ss.language_id = '" . (int)$this->config->get('config_language_id') . "') AS stock_status, (SELECT wcd.unit FROM " . DB_PREFIX . "weight_class_description wcd WHERE p.weight_class_id = wcd.weight_class_id AND wcd.language_id = '" . (int)$this->config->get('config_language_id') . "') AS weight_class, (SELECT lcd.unit FROM " . DB_PREFIX . "length_class_description lcd WHERE p.length_class_id = lcd.length_class_id AND lcd.language_id = '" . (int)$this->config->get('config_language_id') . "') AS length_class, (SELECT AVG(rating) AS total FROM " . DB_PREFIX . "review r1 WHERE r1.product_id = p.product_id AND r1.status = '1' GROUP BY r1.product_id) AS rating, (SELECT COUNT(*) AS total FROM " . DB_PREFIX . "review r2 WHERE r2.product_id = p.product_id AND r2.status = '1' GROUP BY r2.product_id) AS reviews, p.sort_order FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) LEFT JOIN " . DB_PREFIX . "manufacturer m ON (p.manufacturer_id = m.manufacturer_id) WHERE p.product_id = '" . (int)$product_id . "' AND pd.language_id = '" . (int)$this->config->get('config_language_id') . "' AND p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "'");
			
			$query2 = $this->db->query("SELECT customer_id AS vendor_id FROM " . DB_PREFIX . "customerpartner_to_product c2p WHERE (c2p.product_id = '" . (int)$product_id . "' AND c2p.status = '1') ORDER BY c2p.price ASC, c2p.sort_order ASC LIMIT 1");
			
			
			$this->load->model('account/customerpartner');
			$vendor_data = array();
			
			$vendor = $this->model_account_customerpartner->getProfile($vendor_id);
			
			if (!($vendor_id && $vendor)) { if ($query2->num_rows) $vendor_id = $query2->row['vendor_id']; }

			
			if ($vendor_id) {
				$vendor = $this->model_account_customerpartner->getProfile($vendor_id);
				$prices = $this->model_account_customerpartner->getProductPQ($product_id,$vendor_id);
				
				if (!($vendor && $prices)) {
					$curr_vend = array('companyname'=>'','vendor_id'=>'','quantity'=>'','price'=>'');
				} else {
					$curr_vend = array('companyname'=>$vendor['companyname'],'vendor_id'=>$vendor['customer_id'],'price'=>($prices['discount']?$prices['discount']:$prices['price']),'quantity'=>$prices['quantity'],'id'=>$prices['id']);
				}
				$vendor_q = $this->db->query("SELECT * FROM " . DB_PREFIX . "customerpartner_to_product c2p WHERE c2p.product_id = ".(int)$product_id . " AND c2p.customer_id <> ".(int)$vendor_id. " AND status = '1'");
				if ($vendor_q->num_rows > 0) {
					foreach ($vendor_q->rows as $vendors_id) {
						$temp = $this->model_account_customerpartner->getProfile($vendors_id['customer_id']);
						$prices = $this->model_account_customerpartner->getProductPQ($product_id,$vendors_id['customer_id']);
						$vendor_data[] = array(
							'companyname' => $temp['companyname'],
							'vendor_id' => $temp['customer_id'],
							'quantity'=>$prices['quantity'],
							'price'=>$prices['price']
						);
					}
				}
			} else {
				$curr_vend = array('companyname'=>'','vendor_id'=>'','quantity'=>'','price'=>'','id'=>'');
			}
    ]]></add>
    </operation>
		<operation>
			<search><![CDATA[
				'price'            => ($query->row['discount'] ? $query->row['discount'] : $query->row['price']),
				]]></search>
			<add position="replace"><![CDATA[
				'original_price'	=> $query->row['price'],
				'price'            => ($curr_vend['price'])?($curr_vend['price']):($query->row['discount'] ? $query->row['discount'] : $query->row['price']),
				'vendors' => $vendor_data,
				'curr_vendor' => $curr_vend ,
				]]></add>
		</operation>
		<operation>
			<search><![CDATA[
				'quantity'         => $query->row['quantity'],
				]]></search>
			<add position="replace"><![CDATA[
				'quantity'         => ($curr_vend['quantity'])?$curr_vend['quantity']:'0',
				]]></add>
		</operation>	
		<operation>
			<search><![CDATA[
				$sql .= " LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) WHERE pd.language_id = '" . (int)$this->config->get('config_language_id') . "' AND p.status = '1' AND p.type <> '0' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "'";
				]]></search>
			<add position="before"><![CDATA[
				$sql .= " LEFT JOIN " . DB_PREFIX . "customerpartner_to_product c2p ON (p.product_id = c2p.product_id AND c2p.customer_id = (SELECT c2p4.customer_id FROM " . DB_PREFIX . "customerpartner_to_product c2p4 WHERE (c2p4.product_id=p.product_id AND c2p4.status = '1') ORDER BY c2p4.price ASC, c2p4.sort_order ASC LIMIT 1)) ";
				]]></add>
		</operation>	
    </file>
</modification>
