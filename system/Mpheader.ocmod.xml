<?xml version="1.0" encoding="UTF-8"?>
<modification>
        <name>Marketplace for OC v2</name>
        <version>1.0.0</version>
        <code>Webkul Marketplace</code>        
        <author>Webkul</author>
        <link>http://webkul.com</link>
        <file path="admin/model/sale/customer.php">
                <operation>
                        <search><![CDATA[
    public function deleteCustomer($customer_id) {
                        ]]></search>
                        <add position="after"><![CDATA[
    //delete customer data from marketplace if exists    
    $this->load->model('customerpartner/partner');                      
    $this->model_customerpartner_partner->deleteCustomer($customer_id);
                         ]]></add>
                </operation>
               
        </file>
				<!--  display seller name with product in order info and after edit   -->    
        <file path="admin/controller/sale/order.php">
            <operation>
                    <search><![CDATA[
                $data['products'][] = array(
                    ]]></search>
                    <add position="before"><![CDATA[                         

    $seller_details = $this->db->query("SELECT c.customer_id,CONCAT(c.firstname,' ',c.lastname) name,c.email FROM ".DB_PREFIX."customerpartner_to_product c2p LEFT JOIN ".DB_PREFIX."customer c ON (c2p.customer_id = c.customer_id) WHERE c2p.product_id = '".(int)$product['product_id']."' AND c2p.quantity > 0  ORDER BY c2p.sort_order ASC")->row;

    if($seller_details AND isset($seller_details['name']) AND $seller_details['name'])
      $product['name'] = $product['name'].'</a> by Seller <a href="'.$this->url->link('customerpartner/partner', 'token=' . $this->session->data['token'] . '&view_all=1&filter_email=' . $seller_details['email'], 'SSL').'"><b>'.$seller_details['name'].'</b></a>';                      

                      ]]></add>
            </operation>

            <operation>
                    <search><![CDATA[
                $data['order_products'][] = array(
                    ]]></search>
                    <add position="before"><![CDATA[                         

    $seller_details = $this->db->query("SELECT c.customer_id,CONCAT(c.firstname,' ',c.lastname) name,c.email FROM ".DB_PREFIX."customerpartner_to_product c2p LEFT JOIN ".DB_PREFIX."customer c ON (c2p.customer_id = c.customer_id) WHERE c2p.product_id = '".(int)$product['product_id']."' AND c2p.quantity > 0 ORDER BY c2p.sort_order ASC")->row;

    if($seller_details AND isset($seller_details['name']) AND $seller_details['name'])
      $product['name'] = $product['name'].' by Seller <b>'.$seller_details['name'].'</b>';                     

                      ]]></add>
            </operation>
               
        </file>
				<!-- Add Customer as Partner -->
        <file path="admin/controller/sale/customer.php">
					<operation>
						 <search><![CDATA[
							 $this->model_sale_customer->addCustomer($this->request->post);
							 ]]></search>
							<add position="replace"><![CDATA[
                $customer_id = $this->model_sale_customer->addCustomer($this->request->post);
						 ]]></add>
					</operation>
					<operation>
						 <search><![CDATA[
							 $this->model_sale_customer->addCustomer($this->request->post);
							 ]]></search>
							<add position="after"><![CDATA[
                if ($this->request->post['tobecomepartner']=='1' && $this->request->post['shoppartner']) {
                    $this->load->model('customerpartner/customerpartner');
										$this->model_customerpartner_customerpartner->becomePartner($customer_id,$this->request->post['shoppartner']);
                }
						 ]]></add>
					</operation>
					<operation>
						 <search><![CDATA[
							 $this->model_sale_customer->editCustomer($this->request->get['customer_id'], $this->request->post);
							 ]]></search>
							<add position="after"><![CDATA[
                if ($this->request->post['tobecomepartner']=='1' && $this->request->post['shoppartner']) {
                    $this->load->model('customerpartner/customerpartner');
										$this->model_customerpartner_customerpartner->becomePartner($this->request->get['customer_id'],$this->request->post['shoppartner']);
                }
						 ]]></add>
					</operation>					
					<operation>
						 <search><![CDATA[
							 protected function getForm() {
							 ]]></search>
							<add position="after"><![CDATA[
            $this->language->load('sale/customerpartner/become_partner');

            $data['text_register_becomePartner'] = $this->language->get('text_register_becomePartner');
            $data['text_register_douwant'] = $this->language->get('text_register_douwant');
            $data['text_shop_name'] = $this->language->get('text_shop_name');
            $data['text_avaiable'] = $this->language->get('text_avaiable');
            $data['text_no_avaiable'] = $this->language->get('text_no_avaiable');

            if (isset($this->request->post['shoppartner'])) {
                $data['shoppartner'] = $this->request->post['shoppartner'];
            } else {
                $data['shoppartner'] = '';
            }

            if (isset($this->request->post['tobecomepartner'])) {
                $data['tobecomepartner'] = $this->request->post['tobecomepartner'];
            } else {
                $data['tobecomepartner'] = '';
            }

            if (isset($this->error['errshoppartner'])) {
                $data['error_shoppartner'] = $this->error['errshoppartner'];
            } else {
                $data['error_shoppartner'] = '';
            }
						$data['marketplace_customerGroup'] = false;
						if($this->config->get('marketplace_customerGroup')){
								$data['marketplace_customerGroup'] = true;
								$this->load->model("customerpartner/customerpartner");
								$filterData = array (
										'start' => 0,
										'limit' => 50,
										'groupIsParent' => 0,
										'groupStatus' => 'enable',
								);
								$data['parentGroups'] = array();
								$parentGroups = $this->model_customerpartner_customerpartner->getCustomerGroupList($filterData);
								if($parentGroups) {
										foreach($parentGroups as $key => $group) {
												$data['parentGroups'][] = array (
														'id' => $group['id'],
														'name' => $group['name'],
														'description' => $group['description'],
												);
										}
								}
						}
						 ]]></add>
					</operation>
        </file>
       <file path="admin/view/template/sale/customer_form.tpl">
                <operation>
                        <search><![CDATA[
                    <select name="safe" id="input-safe" class="form-control">
                        ]]></search>
                        <add position="after" offset="11"><![CDATA[
          <legend><?php echo $text_register_becomePartner; ?></legend>
          <div class="form-group">
            <label class="col-sm-2 control-label"><?php echo $text_register_douwant; ?></label>
            <div class="col-sm-10">
              <?php if ($tobecomepartner) { ?>
              <label class="radio-inline">
                <input type="radio" name="tobecomepartner" value="1" checked="checked" />
                <?php echo $text_yes; ?></label>
              <label class="radio-inline">
                <input type="radio" name="tobecomepartner" value="0" />
                <?php echo $text_no; ?></label>
              <?php } else { ?>
              <label class="radio-inline">
                <input type="radio" name="tobecomepartner" value="1" />
                <?php echo $text_yes; ?></label>
              <label class="radio-inline">
                <input type="radio" name="tobecomepartner" value="0" checked="checked" />
                <?php echo $text_no; ?></label>
              <?php } ?>
            </div>
          </div>

          <div class="form-group required">
            <label class="col-sm-2 control-label" for="input-shop"><?php echo $text_shop_name; ?></label>
            <div class="col-sm-10">
              <div class="input-group"> 
                <span class="input-group-addon"><i class="fa fa-search"></i></span>
                <input type="text" name="shoppartner" value="<?php echo $shoppartner; ?>" placeholder="<?php echo $text_shop_name; ?>" id="input-shop" class="form-control" />                
              </div>
              <?php if ($error_shoppartner) { ?>
              <div class="text-danger"><?php echo $error_shoppartner; ?></div>
              <?php } ?>
            </div>
          </div>
        <script>
            $( "#input-shop" ).change(function() {
              thisshop = this;
              shop = $(thisshop).val();
              
              if(shop){

                jQuery(thisshop).prev().html('<i class="fa fa-spinner fa-spin"></i>');

                $.ajax({
                       type: 'POST',
                       data: ({shop: shop}),
                       dataType: 'json',
                       url: 'index.php?route=customerpartner/sell/wkmpregistation&token=<?php echo $token;?>',
                       success: function(data){     

                          if(data['success']){
                            jQuery(thisshop).prev().html('<span data-toggle="tooltip" class="text-success" title="<?php echo $text_avaiable; ?>"><i class="fa fa-thumbs-o-up"></i></span>');
                          }else if(data['error']){
                            jQuery(thisshop).prev().html('<span data-toggle="tooltip" class="text-danger" title="<?php echo $text_no_avaiable; ?>"><i class="fa fa-thumbs-o-down"></i></span>');
                          }       
                        
                        }
                    });
              }
            });
        </script>
                              ]]></add>
                </operation>
        </file>
				<!-- Sell Link in header -->
				<file path="catalog/controller/common/header.php">
								<operation>
												<search><![CDATA[
						$data['checkout'] = $this->url->link('checkout/checkout', '', 'SSL');
												]]></search>
												<add position="after"><![CDATA[
						$data['menusell'] = $this->url->link('customerpartner/sell', '', 'SSL');
						$data['menu_buy'] = $this->url->link('account/cd', '', 'SSL');
						$this->language->load('module/marketplace');
						$data['text_sell_header'] = $this->language->get('text_sell_header');
						$data['text_my_profile'] = $this->language->get('text_my_profile');
						$data['text_addproduct'] = $this->language->get('text_addproduct');
						$data['text_wkshipping'] = $this->language->get('text_wkshipping');
						$data['text_productlist'] = $this->language->get('text_productlist');
						$data['text_dashboard'] = $this->language->get('text_dashboard');
						$data['text_orderhistory'] = $this->language->get('text_orderhistory');
						$data['text_becomePartner'] = $this->language->get('text_becomePartner');
						$data['text_download'] = $this->language->get('text_download');
						$data['text_transaction'] = $this->language->get('text_transaction'); 
						$data['t_db'] = "Dashboard";
						$data['t_so'] = "Schedule Order";

						$this->load->model('account/customerpartner');
						$data['chkIsPartner'] = $this->model_account_customerpartner->chkIsPartner();
						$data['mp_addproduct'] = $this->url->link('account/customerpartner/addproduct', '', 'SSL');
						$data['mp_productlist'] = $this->url->link('account/customerpartner/productlist', '', 'SSL');
						$data['mp_dashboard'] = $this->url->link('account/customerpartner/dashboard', '', 'SSL');
						$data['mp_add_shipping_mod'] = $this->url->link('account/customerpartner/add_shipping_mod','', 'SSL');
						$data['mp_orderhistory'] = $this->url->link('account/customerpartner/orderlist','', 'SSL');
						$data['mp_download'] = $this->url->link('account/customerpartner/download','', 'SSL');
						$data['mp_profile'] = $this->url->link('account/customerpartner/profile','','SSL');      
						$data['mp_want_partner'] = $this->url->link('account/customerpartner/become_partner','','SSL'); 
						$data['mp_transaction'] = $this->url->link('account/customerpartner/transaction','','SSL'); 
						$data['b_db'] = $this->url->link('account/cd','','SSL');
						$data['b_so'] = $this->url->link('checkout/orderlater','','SSL');

						$rights = $this->customer->getRights();
						$data['rights'] = $rights['rights'];
						
						]]></add>
								</operation>
				</file>

				<file path="catalog/view/theme/default/template/common/header.tpl">
								<operation>
												<search><![CDATA[
						<li class="dropdown"><a href="<?php echo $account; ?>"
												]]></search>
												<add position="before"><![CDATA[
						<?php if ($logged AND ($rights || $chkIsPartner)) { ?>
							<li class="dropdown"><a href="<?php echo $menusell; ?>" title="<?php echo $menusell; ?>" class="dropdown-toggle" data-toggle="dropdown"><span class="hidden-lg"><i class="fa fa-users"></i></span>
							<span class="hidden-xs hidden-sm hidden-md"><?php echo $text_sell_header; ?></span> <span class="caret"></span></a>
									<ul class="dropdown-menu dropdown-menu-right">
											<li><a href="<?php echo $mp_profile; ?>"><?php echo $text_my_profile; ?></a></li>
											<li><a href="<?php echo $mp_dashboard; ?>"><?php echo $text_dashboard; ?></a></li>
											<li><a href="<?php echo $mp_orderhistory; ?>"><?php echo $text_orderhistory; ?></a></li>
											<li><a href="<?php echo $mp_transaction; ?>"><?php echo $text_transaction; ?></a></li>
											<li><a href="<?php echo $mp_productlist; ?>"><?php echo $text_productlist; ?></a></li>
											<li><a href="<?php echo $mp_download; ?>"><?php echo $text_download; ?></a></li>
											<li><a href="<?php echo $mp_add_shipping_mod; ?>"><?php echo $text_wkshipping; ?></a></li>
											<li role="presentation" class="divider"></li>
									</ul>
							</li>
						<?php } else { ?>
							<li class="dropdown"><a href="<?php echo $menusell; ?>"><span class="hidden-lg"><i class="fa fa-users"></i></span><span class="hidden-xs hidden-sm hidden-md"><?php echo $text_sell_header; ?></span> </a></li>
						<?php } ?>
						
						<?php if ($logged && $rights) { ?>
						<li class="dropdown"><a href="<?php echo $menu_buy; ?>" title="<?php echo $menu_buy; ?>" class="dropdown-toggle" data-toggle="dropdown"><span class="hidden-lg"><i class="fa fa-tachometer"></i></span></span><span class="hidden-xs hidden-sm hidden-md">Dashboard</span> <span class="caret"></span></a>
								<ul class="dropdown-menu dropdown-menu-right" id="dashboard">
									<?php if (in_array('db',$rights)) {?>
										<li><a href="<?php echo $b_db; ?>"><?php echo $t_db; ?></a></li>
										<li><a href="<?php echo $b_so; ?>"><?php echo $t_so; ?></a></li>
										<?php if (isset($modules['cd'])) {?>
											<li><button id="button-pcd" class="btn">Add Products to DashBoard</button></li>
										<?php } ?>
									<?php } ?>
								</ul>
						</li>
						<?php } ?>
						]]></add>
								</operation>
				</file>

				<file path="catalog/controller/account/register.php">
										<operation>
														<search><![CDATA[
						$data['column_left'] = $this->load->controller('common/column_left');
														]]></search>
														<add position="before"><![CDATA[
						$data['marketplace_becomepartnerregistration'] = $this->config->get('marketplace_becomepartnerregistration');
						if($this->config->get('marketplace_becomepartnerregistration')){

								$this->language->load('account/customerpartner/become_partner');

								$data['text_register_becomePartner'] = $this->language->get('text_register_becomePartner');
								$data['text_register_douwant'] = $this->language->get('text_register_douwant');
								$data['text_shop_name'] = $this->language->get('text_shop_name');
								$data['text_avaiable'] = $this->language->get('text_avaiable');
								$data['text_no_avaiable'] = $this->language->get('text_no_avaiable');

								if (isset($this->request->post['shoppartner'])) {
										$data['shoppartner'] = $this->request->post['shoppartner'];
								} else {
										$data['shoppartner'] = '';
								}

								if (isset($this->request->post['tobecomepartner'])) {
										$data['tobecomepartner'] = $this->request->post['tobecomepartner'];
								} else {
										$data['tobecomepartner'] = '';
								}

								if (isset($this->error['errshoppartner'])) {
										$data['error_shoppartner'] = $this->error['errshoppartner'];
								} else {
										$data['error_shoppartner'] = '';
								}

						}
						$data['marketplace_customerGroup'] = false;
						if($this->config->get('marketplace_customerGroup')){
								$data['marketplace_customerGroup'] = true;
								$this->load->model("account/customerpartner");
								$filterData = array (
										'start' => 0,
										'limit' => 50,
										'groupIsParent' => 0,
										'groupStatus' => 'enable',
								);
								$data['parentGroups'] = array();
								$parentGroups = $this->model_account_customerpartner->getCustomerGroupList($filterData);
								if($parentGroups) {
										foreach($parentGroups as $key => $group) {
												$data['parentGroups'][] = array (
														'id' => $group['id'],
														'name' => $group['name'],
														'description' => $group['description'],
												);
										}
								}
						}

														]]></add>
										</operation>

										<operation>
														<search><![CDATA[
						public function validate() {
														]]></search>
														<add position="after"><![CDATA[

						if($this->config->get('marketplace_becomepartnerregistration') AND isset($this->request->post['tobecomepartner'])){        

								$this->language->load('account/customerpartner/become_partner');

								if(utf8_strlen($this->request->post['shoppartner'])<=3 && $this->request->post['tobecomepartner']==1){
										$this->error['errshoppartner'] = $this->language->get('error_validshop');
								}else if(utf8_strlen($this->request->post['shoppartner']) >1 && $this->request->post['tobecomepartner']==1){
										$this->load->model('customerpartner/master');                           
										if(!$this->model_customerpartner_master->getShopData($this->request->post['shoppartner'])){
											$this->error['errshoppartner'] = $this->language->get('error_noshop');
										}
								}

								$this->language->load('account/register');
						}
														]]></add>
										</operation>

										<operation>
														<search><![CDATA[
						unset($this->session->data['guest']);
														]]></search>
														<add position="before"><![CDATA[
								if($this->config->get('marketplace_becomepartnerregistration')){
										if ($this->request->post['tobecomepartner']=='1' && $this->request->post['shoppartner']) {
												$this->load->model('account/customerpartner');
												$this->model_account_customerpartner->becomePartner($this->request->post['shoppartner']);
										} 
								}                

													 ]]></add>
										</operation>

						</file>

    <!--   for delete complete profile after delete seller or customer   -->

        <file path="catalog/view/theme/*/template/account/register.tpl">
                <operation>
                        <search><![CDATA[
                    <?php if ($text_agree) { ?>
                        ]]>
                        </search>
                        <add position="before"><![CDATA[
					<?php if($marketplace_becomepartnerregistration){ ?>

        <fieldset>
          <legend><?php echo $text_register_becomePartner; ?></legend>
          <div class="form-group">
            <label class="col-sm-2 control-label"><?php echo $text_register_douwant; ?></label>
            <div class="col-sm-10">
              <?php if ($tobecomepartner) { ?>
              <label class="radio-inline">
                <input type="radio" name="tobecomepartner" value="1" checked="checked" />
                <?php echo $text_yes; ?></label>
              <label class="radio-inline">
                <input type="radio" name="tobecomepartner" value="0" />
                <?php echo $text_no; ?></label>
              <?php } else { ?>
              <label class="radio-inline">
                <input type="radio" name="tobecomepartner" value="1" />
                <?php echo $text_yes; ?></label>
              <label class="radio-inline">
                <input type="radio" name="tobecomepartner" value="0" checked="checked" />
                <?php echo $text_no; ?></label>
              <?php } ?>
            </div>
          </div>

          <div class="form-group required">
            <label class="col-sm-2 control-label" for="input-shop"><?php echo $text_shop_name; ?></label>
            <div class="col-sm-10">
              <div class="input-group"> 
                <span class="input-group-addon"><i class="fa fa-search"></i></span>
                <input type="text" name="shoppartner" value="<?php echo $shoppartner; ?>" placeholder="<?php echo $text_shop_name; ?>" id="input-shop" class="form-control" />                
              </div>
              <?php if ($error_shoppartner) { ?>
              <div class="text-danger"><?php echo $error_shoppartner; ?></div>
              <?php } ?>
            </div>
          </div>

        </fieldset>

        <script>
            $( "#input-shop" ).change(function() {
              thisshop = this;
              shop = $(thisshop).val();
              
              if(shop){

                jQuery(thisshop).prev().html('<i class="fa fa-spinner fa-spin"></i>');

                $.ajax({
                       type: 'POST',
                       data: ({shop: shop}),
                       dataType: 'json',
                       url: 'index.php?route=customerpartner/sell/wkmpregistation',
                       success: function(data){     

                          if(data['success']){
                            jQuery(thisshop).prev().html('<span data-toggle="tooltip" class="text-success" title="<?php echo $text_avaiable; ?>"><i class="fa fa-thumbs-o-up"></i></span>');
                          }else if(data['error']){
                            jQuery(thisshop).prev().html('<span data-toggle="tooltip" class="text-danger" title="<?php echo $text_no_avaiable; ?>"><i class="fa fa-thumbs-o-down"></i></span>');
                          }       
                        
                        }
                    });
              }
            });
        </script>
    <?php } ?>

    <?php if($marketplace_customerGroup) { ?>
        <fieldset>
            <legend>Become Multi user customer</legend>
            <div class="form-group">
                <label class="col-sm-2 control-label">Customer Group</label>
                <div class="col-sm-10" >
                    <select class="form-control" name="mpCustomerGroup">
                        <option value=""></option>
                        <?php if($parentGroups) { ?>
                            <?php foreach($parentGroups as $key => $group) { ?>
                                <option value="<?php echo $group['id'] ?>" title="<?php echo $group['description'] ?>"><?php echo $group['name'] ?></option>
                            <?php } ?>    
                        <?php } ?>
                    </select>
                </div>
            </div>
        </fieldset>
        <script type="text/javascript">
            $('#account div.form-group:nth-child(2)').css('display','none');
            $('select[name="mpCustomerGroup"]').on('change',function(){
                val = $(this).val();
                $.each($('input[name="customer_group_id"]'),function(){
                    if($(this).val() == val) {
                        $(this).prop("checked","checked");
                    }
                });
            });
        </script>
    <?php } ?>
                              ]]></add>
                </operation>
        </file>


        <!-- send mail to seller after product sold -->


    <file path="catalog/controller/checkout/checkout.php">
    <operation>
    <search><![CDATA[
    $products = $this->cart->getProducts();
    ]]></search>
    <add position="before" offset="1" ><![CDATA[
    /*
    To check customer has access to order or not
    */
    if($this->config->get('marketplace_status')) {
        $this->load->model('account/customerpartner');
        $this->load->language('customerpartner/orderReview');
				
        $customerRights = $this->model_account_customerpartner->getCustomerGroupRights($this->customer->getGroupId());

        $approvedDetails = $this->model_account_customerpartner->getApprovedProducts($this->customer->getId());
        $approveProducts = unserialize($approvedDetails['approve_cart']);

        if($customerRights && !array_key_exists('make-order', $customerRights['rights'])) {
            $this->session->data['forReview'] = true;
            $currentCart = $this->session->data['cart'];
            if($approveProducts) {
                foreach ($currentCart as $key => $value) {
                    if(!array_key_exists($key, $approveProducts)) {
                        $this->session->data['warning'] = $this->language->get('warning_reviewtoadmin');
                        $this->response->redirect($this->url->link('account/customerpartner/orderReview','', 'SSL'));
                    }
                }
            } else if(!$approveProducts) {
                $this->session->data['warning'] = " Warning: You are not allowed to place order without permission, please send your order for review to your administrator!";
                $this->response->redirect($this->url->link('account/customerpartner/orderReview','', 'SSL'));
            }
        }
    }
    /*
    end here
    */
    ]]></add>
    </operation>
    </file>

    <file path="catalog/controller/checkout/checkout_onepage.php">
    <operation>
    <search><![CDATA[
    $this->load->model('checkout/checkout_onepage');
    ]]></search>
    <add position="after"><![CDATA[
    /*
    To check customer has access to order or not
    */
    if($this->config->get('marketplace_status')) {
        $this->load->model('account/customerpartner');
        $this->load->language('customerpartner/orderReview');
				
        $customerRights = $this->model_account_customerpartner->getCustomerGroupRights($this->customer->getGroupId());

        $approvedDetails = $this->model_account_customerpartner->getApprovedProducts($this->customer->getId());
        $approveProducts = unserialize($approvedDetails['approve_cart']);

				$total = $this->cart->getTotal();
				
				$limit =  $this->model_account_customerpartner->getUser();
				
			 if($customerRights && !array_key_exists('make-order', $customerRights['rights'])) {
            $this->session->data['forReview'] = true;
            $currentCart = $this->session->data['cart'];
            if($approveProducts) {
                foreach ($currentCart as $key => $value) {
                    if(!array_key_exists($key, $approveProducts)) {
                        $this->session->data['warning'] = $this->language->get('warning_reviewtoadmin');
                        $this->response->redirect($this->url->link('account/customerpartner/orderReview','', 'SSL'));
                    }
                }
            } else if(!$approveProducts) {
                $this->session->data['warning'] = " Warning: You are not allowed to place order without permission, please send your order for review to your administrator!";
                $this->response->redirect($this->url->link('account/customerpartner/orderReview','', 'SSL'));
            }
        }
				if($limit && ($limit['p_limit'] < $total)) {
				
						$this->session->data['forReview'] = true;
            $currentCart = $this->session->data['cart'];
            if($approveProducts) {
                foreach ($currentCart as $key => $value) {
                    if(!array_key_exists($key, $approveProducts)) {
                        $this->session->data['warning'] = $this->language->get('warning_reviewtoadmin');
                        $this->response->redirect($this->url->link('account/customerpartner/orderReview','', 'SSL'));
                    }
                }
            } else if(!$approveProducts) {
                $this->session->data['warning'] = " Warning: You have crossed the purchase limit, please send your order for review to your administrator!";
                $this->response->redirect($this->url->link('account/customerpartner/orderReview','', 'SSL'));
            }
				}
        
    }
    /*
    end here
    */
    ]]></add>
    </operation>
    </file>

    <file path="catalog/controller/checkout/confirm.php,catalog/controller/checkout/confirm_onepage.php">
    <operation>
    <search><![CDATA[
    $customer_info = $this->model_account_customer->getCustomer($this->customer->getId());
    ]]></search>
    <add position="replace" offset="2" ><![CDATA[
    /*
    To order by company name not by sub user
    */
    if($this->config->get('marketplace_status')) {
       $this->load->model('account/customerpartner');
       $sellerId = $this->model_account_customerpartner->isSubUser($this->customer->getId());
       if($sellerId) {
            $sellerId = $sellerId;
       } else {
            $sellerId = $this->customer->getId();
       }
       $customer_info = $this->model_account_customer->getCustomer($sellerId);
       $order_data['customer_id'] = $sellerId;
    } else {
        $customer_info = $this->model_account_customer->getCustomer($this->customer->getId());
        $order_data['customer_id'] = $this->customer->getId();
    }
    /*
    end here
    */
    ]]></add>
    </operation>
    </file>

    <file path="catalog/controller/checkout/success.php">
    <operation>
    <search><![CDATA[
    $this->cart->clear();
    ]]></search>
    <add position="after" ><![CDATA[
            /*
            To close previous review
            */
            if($this->config->get('marketplace_status')) {
               $this->load->model('account/customerpartner');
               $this->model_account_customerpartner->closePreviousReview($this->customer->getId(),$this->session->data['order_id']);
            }
            /*
            end here
            */
    ]]></add>
    </operation>
    </file>

    <file path="catalog/model/account/order.php">
    <operation>
    <search><![CDATA[
    $order_query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "order` WHERE order_id = '" . (int)$order_id . "' AND customer_id = '" . (int)$this->customer->getId() . "' AND order_status_id > '0'");
    ]]></search>
    <add position="replace" ><![CDATA[
        /*
        To get company orders not individuals for sub users
        */
        if($this->config->get('marketplace_status')) {
           $this->load->model('account/customerpartner');
           $sellerId = $this->model_account_customerpartner->isSubUser($this->customer->getId());
           if($sellerId) {
                $sellerId = $sellerId;
           } else {
                $sellerId = $this->customer->getId();
           }
           $order_query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "order` WHERE order_id = '" . (int)$order_id . "' AND customer_id = '" . (int)$sellerId . "' AND order_status_id > '0'");
        } else {
            $order_query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "order` WHERE order_id = '" . (int)$order_id . "' AND customer_id = '" . (int)$this->customer->getId() . "' AND order_status_id > '0'");
        }
        /*
        end here
        */
    ]]></add>
    </operation>
    <operation>
    <search><![CDATA[
    $query = $this->db->query("SELECT o.order_id, o.firstname, o.lastname, os.name as status, o.date_added, o.total, o.currency_code, o.currency_value FROM `" . DB_PREFIX . "order` o LEFT JOIN " . DB_PREFIX . "order_status os ON (o.order_status_id = os.order_status_id) WHERE o.customer_id = '" . (int)$this->customer->getId() . "' AND o.order_status_id > '0' AND o.store_id = '" . (int)$this->config->get('config_store_id') . "' AND os.language_id = '" . (int)$this->config->get('config_language_id') . "' ORDER BY o.order_id DESC LIMIT " . (int)$start . "," . (int)$limit);
    ]]></search>
    <add position="replace" ><![CDATA[
        /*
        To get company orders not individuals for sub users
        */
        if($this->config->get('marketplace_status')) {
           $this->load->model('account/customerpartner');
           $sellerId = $this->model_account_customerpartner->isSubUser($this->customer->getId());
           if($sellerId) {
                $sellerId = $sellerId;
           } else {
                $sellerId = $this->customer->getId();
           }
           $query = $this->db->query("SELECT o.order_id, o.firstname, o.lastname, os.name as status, o.date_added, o.total, o.currency_code, o.currency_value FROM `" . DB_PREFIX . "order` o LEFT JOIN " . DB_PREFIX . "order_status os ON (o.order_status_id = os.order_status_id) WHERE o.customer_id = '" . (int)$sellerId . "' AND o.order_status_id > '0' AND o.store_id = '" . (int)$this->config->get('config_store_id') . "' AND os.language_id = '" . (int)$this->config->get('config_language_id') . "' ORDER BY o.order_id DESC LIMIT " . (int)$start . "," . (int)$limit);
        } else {
            $query = $this->db->query("SELECT o.order_id, o.firstname, o.lastname, os.name as status, o.date_added, o.total, o.currency_code, o.currency_value FROM `" . DB_PREFIX . "order` o LEFT JOIN " . DB_PREFIX . "order_status os ON (o.order_status_id = os.order_status_id) WHERE o.customer_id = '" . (int)$this->customer->getId() . "' AND o.order_status_id > '0' AND o.store_id = '" . (int)$this->config->get('config_store_id') . "' AND os.language_id = '" . (int)$this->config->get('config_language_id') . "' ORDER BY o.order_id DESC LIMIT " . (int)$start . "," . (int)$limit);
        }
        /*
        end here
        */
    ]]></add>
    </operation>
    <operation>
    <search><![CDATA[
    $query = $this->db->query("SELECT COUNT(*) AS total FROM `" . DB_PREFIX . "order` o WHERE customer_id = '" . (int)$this->customer->getId() . "' AND o.order_status_id > '0' AND o.store_id = '" . (int)$this->config->get('config_store_id') . "'");
    ]]></search>
    <add position="replace" ><![CDATA[
        /*
        To get company orders not individuals for sub users
        */
        if($this->config->get('marketplace_status')) {
           $this->load->model('account/customerpartner');
           $sellerId = $this->model_account_customerpartner->isSubUser($this->customer->getId());
           if($sellerId) {
                $sellerId = $sellerId;
           } else {
                $sellerId = $this->customer->getId();
           }
           $query = $this->db->query("SELECT COUNT(*) AS total FROM `" . DB_PREFIX . "order` o WHERE customer_id = '" . (int)$sellerId . "' AND o.order_status_id > '0' AND o.store_id = '" . (int)$this->config->get('config_store_id') . "'");
        } else {
            $query = $this->db->query("SELECT COUNT(*) AS total FROM `" . DB_PREFIX . "order` o WHERE customer_id = '" . (int)$this->customer->getId() . "' AND o.order_status_id > '0' AND o.store_id = '" . (int)$this->config->get('config_store_id') . "'");
        }
        /*
        end here
        */
    ]]></add>
    </operation>
    </file>
    
 		<file path="catalog/controller/product/category.php,catalog/controller/product/manufacturer.php,catalog/controller/product/search.php">
			<operation>
				<search><![CDATA[
					$price = $this->currency->format($this->tax->calculate($result['price'], $result['tax_class_id'], $this->config->get('config_tax')));
				]]></search>
				<add position="after"><![CDATA[
					$original_price  = 0;
					$discount = 0;				
					if ($result['price'] < $result['original_price']) {
						$original_price = $this->currency->format($this->tax->calculate($result['original_price'], $result['tax_class_id'], $this->config->get('config_tax')));
						$discount = (int)(($result['original_price'] - $result['price'])*100/$result['original_price']);
					}
				]]></add>
			</operation>
			<operation>
				<search><![CDATA[
					'price'       => $price,
				]]></search>
				<add position="after"><![CDATA[
					'original_price' => $original_price,
					'discount' => $discount,				
				]]></add>
			</operation>
    </file>
</modification>
