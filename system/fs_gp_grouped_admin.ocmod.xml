<?xml version="1.0" encoding="utf-8"?>
<modification>
	<code>fs_gp_grouped_admin</code>
	<name>Grouped Product - Grouped Admin</name>
	<version>6.1.0</version>
	<author>Fabio Messina - fabiome77@hotmail.it</author>
	<link>http://www.fabiom7.com</link>
<file path="admin/view/template/common/menu.tpl">
	<operation info=" main menu ">
		<search><![CDATA[
		<li><a href="<?php echo $feed; ?>"><?php echo $text_feed; ?></a></li>
		]]></search>
		<add position="after"><![CDATA[
		<li><a href="<?php echo $gp_grouped; ?>">GP Grouped</a></li>
  		]]></add>
	</operation>
</file>
<file path="admin/controller/common/menu.php">
	<operation info=" main menu ">
		<search><![CDATA[
		$data['feed'] = $this->url->link('extension/feed', 'token=' . $this->session->data['token'], 'SSL');
		]]></search>
		<add position="after"><![CDATA[
		$data['gp_grouped'] = $this->url->link('extension/gp_grouped', 'token=' . $this->session->data['token'], 'SSL');
  		]]></add>
	</operation>
</file>
<file path="admin/view/template/catalog/product_list.tpl">
	<operation info=" button add gp ">
		<search><![CDATA[
		<h1><?php echo $heading_title; ?></h1>
		]]></search>
		<add position="before"><![CDATA[
		<div class="pull-right"><a href="<?php echo $add_gp_grouped; ?>" data-toggle="tooltip" title="<?php echo $button_add; ?>" class="btn btn-primary"><i class="fa fa-plus"></i> Grouped</a>&nbsp;</div>
  		]]></add>
	</operation>
	<operation info=" gp filter - getList() ">
		<search><![CDATA[
		<h3 class="panel-title"><i class="fa fa-list"></i> <?php echo $text_list; ?></h3>
		]]></search>
		<add position="after"><![CDATA[
        <?php if (isset($filter_gpt) && $filter_gpt == 'gp_grouped') { ?>
        - <a href="index.php?route=catalog/product&token=<?php echo $token; ?>" style="text-decoration:underline;font-weight:bold;">Grouped</a>
        <?php } else { ?>
        - <a href="index.php?route=catalog/product&token=<?php echo $token; ?>&filter_gpt=gp_grouped">Grouped</a>
        <?php } ?>
		]]></add>
	</operation>
</file>
<file path="admin/controller/catalog/product.php">
	<operation info=" getList() ">
		<search><![CDATA[
		$data['add'] = $this->url->link('catalog/product/add', 'token=' . $this->session->data['token'] . $url, 'SSL');
		]]></search>
		<add position="before"><![CDATA[
		$data['add_gp_grouped'] = $this->url->link('catalog/product/add', 'token=' . $this->session->data['token'] . $url . '&is_gp=grouped', 'SSL');
  		]]></add>
	</operation>
	<operation info=" getList() ">
		<search><![CDATA[
		$data['products'][] = array(
		]]></search>
		<add position="before"><![CDATA[
		if ($is_gp = $this->model_catalog_product->getGroupedProductGrouped($result['product_id'])) {
			$result['name'] .= '<br /> [GP Grouped]';

			if ($is_gp['gp_price_min']) {
				$result['price'] .= '<br />From: ' . $is_gp['gp_price_min'];
			}

			if ($is_gp['gp_price_max']) {
				$result['price'] .= '<br />To: ' . $is_gp['gp_price_max'];
			}
		}
  		]]></add>
	</operation>
	<operation info=" getForm() ">
		<search><![CDATA[
		protected function getForm() {
		]]></search>
		<add position="after"><![CDATA[
		if (isset($this->request->get['is_gp']) && $this->request->get['is_gp'] == 'grouped' || isset($this->request->post['is_gp']) && $this->request->post['is_gp'] == 'grouped' || isset($this->request->get['product_id']) && $this->model_catalog_product->getGroupedProductGrouped($this->request->get['product_id'])) {
			$data['is_gp'] = 'grouped';

			$this->load->language('catalog/gp_grouped');

			$data['tab_gp_data'] = $this->language->get('tab_gp_data');
			$data['column_gp_childs'] = $this->language->get('column_gp_childs');

			$data['column_gp_child_id'] = $this->language->get('column_gp_child_id');
			$data['column_gp_child_name'] = $this->language->get('column_gp_child_name');
			$data['column_gp_child_model'] = $this->language->get('column_gp_child_model');
			$data['column_gp_child_price'] = $this->language->get('column_gp_child_price');
			$data['column_gp_child_sort_order'] = $this->language->get('column_gp_child_sort_order');

			$data['text_gp_min'] = $this->language->get('text_gp_min');
			$data['text_gp_max'] = $this->language->get('text_gp_max');

			$data['entry_gp_template'] = $this->language->get('entry_gp_template');
			$data['entry_gp_price_mask'] = $this->language->get('entry_gp_price_mask');

			$data['help_gp_price_mask'] = $this->language->get('help_gp_price_mask');

			// GP Parent data
			if (isset($this->request->get['product_id'])) {
				$gp_data = $this->model_catalog_product->getGroupedProductGrouped($this->request->get['product_id']);
			}

			// GP Parent available layouts
			$data['gp_templates'] = array();
			foreach (glob(DIR_CATALOG . 'view/theme/' . $this->config->get('config_template') . '/template/product/gp_grouped_*.tpl') as $tpl) {
				$part = explode('_', basename($tpl, '.tpl'));
				$data['gp_templates'][] = array(
					'template' => $part[2],
					'file'     => 'gp_grouped_' . $part[2] . '.tpl'
				);
			}

			if (isset($this->request->post['gp_template'])) {
				$data['gp_template'] = $this->request->post['gp_template'];
			} elseif (isset($this->request->get['product_id'])) {
				$data['gp_template'] = $gp_data['gp_template'];
			} else {
				$data['gp_template'] = 'default';
			}

			if (isset($this->request->post['gp_price_min'])) {
				$data['gp_price_min'] = $this->request->post['gp_price_min'];
			} elseif (isset($this->request->get['product_id'])) {
				$data['gp_price_min'] = $gp_data['gp_price_min'];
			} else {
				$data['gp_price_min'] = '';
			}

			if (isset($this->request->post['gp_price_max'])) {
				$data['gp_price_max'] = $this->request->post['gp_price_max'];
			} elseif (isset($this->request->get['product_id'])) {
				$data['gp_price_max'] = $gp_data['gp_price_max'];
			} else {
				$data['gp_price_max'] = '';
			}

			// GP Options and Childs
			if (isset($this->request->post['gp_child'])) {
				$gps = $this->request->post['gp_child'];
			} elseif (isset($this->request->get['product_id'])) {
				$gps = $this->model_catalog_product->getGroupedProductGroupedChilds($this->request->get['product_id']);
			} else {
				$gps = array();
			}

			$data['gps'] = array();

				foreach ($gps as $child_id => $child) {
					$child_info = $this->model_catalog_product->getProduct($child_id);

					if ($child_info) {
						if ($this->model_catalog_product->getProductOptions($child_info['product_id'])) {
							$child_has_options = $this->language->get('text_gp_child_has_options');
						} else {
							$child_has_options = '';
						}

						$child_info_special = false;
						$child_specials = $this->model_catalog_product->getProductSpecials($child_info['product_id']);
						foreach ($child_specials as $child_special) {
							if (($child_special['date_start'] == '0000-00-00' || $child_special['date_start'] < date('Y-m-d')) && ($child_special['date_end'] == '0000-00-00' || $child_special['date_end'] > date('Y-m-d'))) {
								$child_info_special = $child_special['price'];
								break;
							}
						}

						$data['gps'][] = array(
							'child_id'         => $child_info['product_id'],
							'name'             => $child_info['name'] . $child_has_options,
							'model'            => $child_info['model'],
							'price'            => $child_info['price'],
							'special'          => $child_info_special,
							'href' => $this->url->link('catalog/product/edit', 'token=' . $this->session->data['token'] . '&product_id=' . $child_id, 'SSL'),
							'child_sort_order' => $child['child_sort_order']
						);
					}
				}
		}
  		]]></add>
	</operation>
</file>
<file path="admin/view/template/catalog/product_form.tpl">
	<operation info=" gp tab ">
		<search><![CDATA[
		<li><a href="#tab-data" data-toggle="tab"><?php echo $tab_data; ?></a></li>
		]]></search>
		<add position="after"><![CDATA[
		<?php if (isset($is_gp) && $is_gp == 'grouped') { ?>
		<li><a href="#tab-gp" data-toggle="tab"><?php echo $tab_gp_data; ?></a></li>
		<?php } ?>
  		]]></add>
	</operation>
	<operation info=" gp-tab ">
		<search><![CDATA[
		<div class="tab-pane" id="tab-data">
		]]></search>
		<add position="before"><![CDATA[
		<?php if (isset($is_gp) && $is_gp == 'grouped') { ?>
		<input type="hidden" name="is_gp" value="grouped" />
		
		<div class="tab-pane" id="tab-gp">
			<div class="form-group">
				<label class="col-sm-2 control-label" for=""><?php echo $entry_gp_template; ?></label>
				<div class="col-sm-10">
					<select type="text" name="gp_template" class="form-control">
						<?php foreach ($gp_templates as $value) { ?>
						<?php if ($value['template'] == $gp_template) { ?>
						<option value="<?php echo $value['template']; ?>" selected="selected"><?php echo $value['file']; ?></option>
						<?php } else { ?>
						<option value="<?php echo $value['template']; ?>"><?php echo $value['file']; ?></option>
						<?php } ?>
						<?php } ?>
					</select>
				</div>
			</div>
			<div class="form-group">
				<label class="col-sm-2 control-label" for=""><span data-toggle="tooltip" title="<?php echo $help_gp_price_mask; ?>"><?php echo $entry_gp_price_mask; ?></span></label>
				<div class="col-sm-10"><div class="row">
					<div class="col-sm-6"><div class="input-group">
						<span class="input-group-addon"><?php echo $text_gp_min; ?></span>
						<input type="text" name="gp_price_min" value="<?php echo $gp_price_min; ?>" title="" class="form-control" />
					</div></div>
					<div class="col-sm-6"><div class="input-group">
						<span class="input-group-addon"><?php echo $text_gp_max; ?></span>
						<input type="text" name="gp_price_max" value="<?php echo $gp_price_max; ?>" class="form-control" />
					</div></div>
				</div></div>
			</div>
			<div class="table-responsive">
			<table class="table table-striped table-bordered table-hover">
				<thead>
					<tr class="info">
						<td class="text-left text-nowrap"><?php echo $column_gp_child_id; ?></td>
						<td class="text-left text-nowrap"><?php echo $column_gp_child_name; ?></td>
						<td class="text-left text-nowrap"><?php echo $column_gp_child_model; ?></td>
						<td class="text-left text-nowrap"><?php echo $column_gp_child_price; ?></td>
						<td class="text-left text-nowrap" style="width:1px;"><?php echo $column_gp_child_sort_order; ?></td>
						<td class="text-left text-nowrap"></td>
					</tr>
				</thead>
				<tbody id="gp-rows">
					<?php foreach ($gps as $child) { ?>
					<tr id="gp-row-child-<?php echo $child['child_id']; ?>">
						<td class="text-left"><?php echo $child['child_id']; ?></td>
						<td class="text-left"><a title="edit" onclick="window.open('<?php echo $child['href']; ?>','','width=1200,height=500,top=99');"><?php echo $child['name']; ?></a></td>
						<td class="text-left"><?php echo $child['model']; ?></td>
						<td class="text-left">
							<?php if ((float)$child['special']) { ?>
							<span style="text-decoration:line-through"><?php echo $child['price']; ?></span><br /> <?php echo $child['special']; ?>
							<?php } else { ?>
							<?php echo $child['price']; ?>
							<?php } ?></td>
						<td class="text-left"><input type="text" name="gp_child[<?php echo $child['child_id']; ?>][child_sort_order]" value="<?php echo $child['child_sort_order']; ?>" class="form-control" /></td>
						<td class="text-left"><button type="button" onclick="$(this).tooltip('destroy');$('#gp-row-child-<?php echo $child['child_id']; ?>').remove();" data-toggle="tooltip" title="<?php echo $button_remove; ?>" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button></td>
					</tr>
					<?php } ?>
				</tbody>
				<tfoot>
					<tr>
						<td class="text-left"></td>
						<td class="text-left"><input type="text" onkeyup="gpAddChild($(this), 'name');" value="" class="form-control" /></td>
						<td class="text-left"><input type="text" onkeyup="gpAddChild($(this), 'model');" value="" class="form-control" /></td>
						<td class="text-left"></td>
						<td class="text-left"></td>
						<td class="text-left"></td>
					</tr>
				</tfoot>
			</table>
			</div>
		</div>
<script type="text/javascript"><!--
function gpAddChild(theInput, theFilter) {
	theInput.autocomplete({
		'source': function(request, response) {
			$.ajax({
				url: 'index.php?route=catalog/product/autocomplete&token=<?php echo $token; ?>&filter_' + theFilter + '=' +  encodeURIComponent(request),
				dataType: 'json',			
				success: function(json) {
					response($.map(json, function(item) {
						return {
							label: (theFilter == 'name') ? item['name'] : item['model'],
							value: item['product_id'],
							name: item['name'],
							model: item['model'],
							price: item['price']
						}
					}));
				}
			});
		},
		'select': function(item) {
			theInput.val('');
			$('#gp-row-child-' + item['value']).remove();

			html  = '<tr id="gp-row-child-' + item['value'] + '">';
			html += '  <td class="text-left">' + item['value'] + '</td>';
			html += '  <td class="text-left">' + item['name'] + '</td>';
			html += '  <td class="text-left">' + item['model'] + '</td>';
			html += '  <td class="text-left">' + item['price'] + '</td>';
			html += '  <td class="text-left">';
			html += '    <input type="text" name="gp_child[' + item['value'] + '][child_sort_order]" value="" class="form-control" />';
			html += '  </td>';
			html += '  <td class="text-left">';
			html += '    <button type="button" onclick="$(this).tooltip(\'destroy\');$(\'#gp-row-child-' + item['value'] + '\').remove();" data-toggle="tooltip" title="<?php echo $button_remove; ?>" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button>';
			html += '  </td>';
			html += '</tr>';

			$('#gp-rows').append(html);
		}
	});
}
//--></script>
<script type="text/javascript"><!--
$(document).ready(function() {
	// Remove from GP common
	$('#form-group-gp-parent-id').remove();

	// Replace/Remove default
	$('label[for="input-tax-class"]').wrapInner('<span data-toggle="tooltip" title="GP Price Mask. No taxes override."></span>');
	$('[data-toggle=\'tooltip\']').tooltip({container: 'body'});
	
	$('#input-price, #input-quantity, #input-minimum, #input-subtract, #input-stock-status, input[name="shipping"]').attr('title', 'GP - Useless').css('background', '#ccc');
	$('label[for="input-download"]').parent('div').remove();
	$('a[href="#tab-option"]').parent('li').remove();
	$('#tab-option').remove();
	$('a[href="#tab-recurring"]').parent('li').remove();
	$('#tab-recurring').remove();
	$('a[href="#tab-discount"]').parent('li').remove();
	$('#tab-discount').remove();
	$('a[href="#tab-special"]').parent('li').remove();
	$('#tab-special').remove();
	$('a[href="#tab-reward"]').parent('li').remove();
	//$('#tab-reward').remove();
});
//--></script>
		<?php } ?>
		]]></add>
	</operation>
</file>
<file path="admin/model/catalog/product.php">
	<operation>
		<search><![CDATA[
		public function addProduct($data) {
		]]></search>
		<add position="before"><![CDATA[
		public function insertGroupedProductGrouped($product_id, $data) {
			
			$implode = array();
			
			if (isset($data['gp_child'])) {
				foreach ($data['gp_child'] as $child_id => $child) {
					$implode[] = $child_id;
				}
			}
			
			$data['gp_price_min'] = $this->db->query("SELECT MIN(price) AS price FROM " . DB_PREFIX . "product WHERE product_id IN (".implode(',',$implode).")")->row['price'];
			
			$data['gp_price_max'] = $this->db->query("SELECT MAX(price) AS price FROM " . DB_PREFIX . "product WHERE product_id IN (".implode(',',$implode).")")->row['price'];
			
			$data_gp_price_min = $data['gp_price_min'] ? $data['gp_price_min'] : 0; //set zero just to prevent error in mask
			$data_gp_price_max = $data['gp_price_max'] ? $data['gp_price_max'] : 0; //set zero just to prevent error in mask
			
			$this->db->query("INSERT INTO " . DB_PREFIX . "gp_grouped SET product_id = '" . (int)$product_id . "', gp_price_min = '" . $this->db->escape($data_gp_price_min) . "', gp_price_max = '" . $this->db->escape($data_gp_price_max) . "', gp_template = '" . $this->db->escape($data['gp_template']) . "'");
			
			$this->db->query("UPDATE " . DB_PREFIX . "product SET type = '2' WHERE product_id = '" . (int)$product_id . "'");
			
			if (isset($data['gp_child'])) {
				foreach ($data['gp_child'] as $child_id => $child) {
					$this->db->query("INSERT INTO " . DB_PREFIX . "gp_grouped_child SET product_id = '" . (int)$product_id . "', child_id = '" . (int)$child_id . "', child_sort_order = '" . (int)$child['child_sort_order'] . "'");
					$this->db->query("UPDATE " . DB_PREFIX . "product SET type = '0' WHERE product_id = '" . (int)$child_id . "'");
					$this->db->query("UPDATE " . DB_PREFIX . "product SET status = '".$data['status']."' WHERE product_id = '" . (int)$child_id . "' AND status <> '0'");
				}
			}
		}

		// Deleting
		public function deleteGroupedProductGrouped($product_id) {
			$this->db->query("DELETE FROM " . DB_PREFIX . "gp_grouped WHERE product_id = '" . (int)$product_id . "'");
			$this->db->query("DELETE FROM " . DB_PREFIX . "gp_grouped_child WHERE product_id = '" . (int)$product_id . "'");
		}

		// Getting
		public function getGroupedProductGrouped($product_id) {
			$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "gp_grouped WHERE product_id = '" . (int)$product_id . "'");

			return $query->row;
		}

		public function getGroupedProductGroupedChilds($product_id) {
			$child_data = array();

			$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "gp_grouped_child WHERE product_id = '" . (int)$product_id . "' ORDER BY child_sort_order");

			foreach ($query->rows as $result) {
				$child_data[$result['child_id']] = array(
					'child_id'         => $result['child_id'],
					'child_sort_order' => $result['child_sort_order']
				);
			}

			return $child_data;
		}
		]]></add>
	</operation>
	<operation info=" addProduct($data) ">
		<search><![CDATA[
		$product_id = $this->db->getLastId();
		]]></search>
		<add position="after"><![CDATA[
		if (isset($data['is_gp']) && $data['is_gp'] == 'grouped') {
			$this->insertGroupedProductGrouped($product_id, $data);
		}
		]]></add>
	</operation>
	<operation info=" editProduct($product_id, $data) ">
		<search><![CDATA[
		public function editProduct($product_id, $data) {
		]]></search>
		<add position="after"><![CDATA[
		if (isset($data['is_gp']) && $data['is_gp'] == 'grouped') {
			$this->deleteGroupedProductGrouped($product_id);
			$this->insertGroupedProductGrouped($product_id, $data);
		}
		]]></add>
	</operation>
	<operation info=" deleteProduct($product_id) ">
		<search><![CDATA[
		public function deleteProduct($product_id) {
		]]></search>
		<add position="after"><![CDATA[
		$this->deleteGroupedProductGrouped($product_id);
		]]></add>
	</operation>
</file>
</modification>
